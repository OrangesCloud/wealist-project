name: Backend EC2 CD - OIDC (Production Ready)

# OIDC ê¸°ë°˜ ë³´ì•ˆ ê°•í™” ë°°í¬
# - GitHub Secretsì— AWS Access Key ì €ì¥ ì•ˆí•¨
# - ì„ì‹œ ìê²©ì¦ëª… ìë™ ë°œê¸‰ (1ì‹œê°„ ìœ íš¨)
# - íŠ¹ì • Repository + Branchë§Œ í—ˆìš©

on:
  workflow_run:
    workflows:
      - "User Service CI - ECR"
      - "Board Service CI - ECR"
    types:
      - completed
    branches:
      - deploy-dev
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2

# â­ OIDC í† í° ìƒì„± ê¶Œí•œ í•„ìˆ˜
permissions:
  id-token: write   # OIDC í† í° ìƒì„±
  contents: read    # ì½”ë“œ ì½ê¸°

jobs:
  deploy-to-ec2:
    name: Secure Deploy via SSM + OIDC
    runs-on: ubuntu-latest
    environment: development  # Environment Protection Rules ì‚¬ìš© ì‹œ
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      # ============================================
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # ============================================
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # ============================================
      # 2. AWS Credentials ì„¤ì • (OIDC)
      # ============================================
      - name: ğŸ” Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # â­ OIDC Role ARN (terraform outputì—ì„œ í™•ì¸)
          role-to-assume: arn:aws:iam::${{ secrets.WEALIST_DEV_AWS_ACCOUNT_ID }}:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}
          # Access Key ë¶ˆí•„ìš”! OIDCê°€ ìë™ìœ¼ë¡œ ì„ì‹œ ìê²©ì¦ëª… ë°œê¸‰

      # ============================================
      # 3. AWS ì—°ê²° í™•ì¸
      # ============================================
      - name: âœ… Verify AWS Connection
        run: |
          echo "ğŸ” Verifying AWS connection..."
          aws sts get-caller-identity
          echo "âœ… AWS connection successful!"

      # ============================================
      # 4. Docker Compose íŒŒì¼ ì¤€ë¹„
      # ============================================
      - name: ğŸ“‹ Prepare Docker Compose File
        run: |
          cp docker/compose/docker-compose.ec2-dev.yml /tmp/docker-compose.yml

      # ============================================
      # 5. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
      # ============================================
      - name: ğŸ“ Create Secure Deployment Script
        run: |
          cat > /tmp/deploy-secure.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e

          echo "=========================================="
          echo "ğŸ”’ Secure Deployment Started (OIDC)"
          echo "=========================================="

          REGION="ap-northeast-2"
          AWS_ACCOUNT_ID="${{ secrets.WEALIST_DEV_AWS_ACCOUNT_ID }}"

          # ë°°í¬ ë””ë ‰í† ë¦¬
          mkdir -p ~/wealist-deploy
          cd ~/wealist-deploy

          echo "ğŸ”‘ Fetching secrets from Parameter Store..."

          # Parameter Storeì—ì„œ ì•ˆì „í•˜ê²Œ ê°’ ê°€ì ¸ì˜¤ê¸°
          POSTGRES_SUPERUSER_PASSWORD=$(aws ssm get-parameter \
            --name "/wealist/dev/postgres/superuser-password" \
            --with-decryption \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          USER_DB_PASSWORD=$(aws ssm get-parameter \
            --name "/wealist/dev/db/user-password" \
            --with-decryption \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          BOARD_DB_PASSWORD=$(aws ssm get-parameter \
            --name "/wealist/dev/db/board-password" \
            --with-decryption \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          REDIS_PASSWORD=$(aws ssm get-parameter \
            --name "/wealist/dev/redis/password" \
            --with-decryption \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          JWT_SECRET=$(aws ssm get-parameter \
            --name "/wealist/dev/jwt/secret" \
            --with-decryption \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          GOOGLE_CLIENT_ID=$(aws ssm get-parameter \
            --name "/wealist/dev/oauth/google-client-id" \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          GOOGLE_CLIENT_SECRET=$(aws ssm get-parameter \
            --name "/wealist/dev/oauth/google-client-secret" \
            --with-decryption \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          GRAFANA_ADMIN_PASSWORD=$(aws ssm get-parameter \
            --name "/wealist/dev/grafana/admin-password" \
            --with-decryption \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          echo "âœ… Secrets fetched successfully"

          # .env íŒŒì¼ ìƒì„±
          cat > .env << ENVFILE
          # AWS
          AWS_REGION=${REGION}
          AWS_ACCOUNT_ID=${AWS_ACCOUNT_ID}
          VERSION=latest

          # PostgreSQL Superuser
          POSTGRES_SUPERUSER=postgres
          POSTGRES_SUPERUSER_PASSWORD=${POSTGRES_SUPERUSER_PASSWORD}

          # User Service DB
          USER_DB_NAME=wealist_user_db
          USER_DB_USER=wealist_user
          USER_DB_PASSWORD=${USER_DB_PASSWORD}

          # Board Service DB
          BOARD_DB_NAME=wealist_board_db
          BOARD_DB_USER=wealist_board
          BOARD_DB_PASSWORD=${BOARD_DB_PASSWORD}

          # Redis
          REDIS_PASSWORD=${REDIS_PASSWORD}

          # JWT
          JWT_SECRET=${JWT_SECRET}
          JWT_ACCESS_TOKEN_EXPIRATION_MS=1800000
          JWT_REFRESH_TOKEN_EXPIRATION_MS=604800000

          # OAuth
          GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
          GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}

          # Service Configuration
          JPA_DDL_AUTO=update
          JPA_SHOW_SQL=true
          JPA_FORMAT_SQL=true
          LOG_LEVEL=debug
          CORS_ORIGINS=*

          # Monitoring
          GRAFANA_ADMIN_USER=admin
          GRAFANA_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
          ENVFILE

          # ë³´ì•ˆ: .env íŒŒì¼ ê¶Œí•œ ì œí•œ
          chmod 600 .env

          echo "âœ… Environment file created securely"

          # ECR ë¡œê·¸ì¸
          echo "ğŸ”‘ Logging into Amazon ECR..."
          aws ecr get-login-password --region ${REGION} | \
            docker login --username AWS --password-stdin \
            ${AWS_ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com

          # ìµœì‹  ì´ë¯¸ì§€ Pull
          echo "ğŸ“¥ Pulling latest images from ECR..."
          docker compose pull

          # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          echo "ğŸ”„ Restarting services..."
          docker compose up -d --remove-orphans

          # êµ¬ ì´ë¯¸ì§€ ì •ë¦¬
          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -f

          echo ""
          echo "=========================================="
          echo "âœ… Secure Deployment Complete!"
          echo "=========================================="
          docker compose ps

          # Health Check
          echo ""
          echo "ğŸ¥ Running Health Checks..."
          sleep 30

          USER_HEALTH=$(curl -f http://localhost:8080/actuator/health 2>/dev/null && echo "âœ… Healthy" || echo "âš ï¸ Not Ready")
          BOARD_HEALTH=$(curl -f http://localhost:8000/health 2>/dev/null && echo "âœ… Healthy" || echo "âš ï¸ Not Ready")

          echo "User Service: ${USER_HEALTH}"
          echo "Board Service: ${BOARD_HEALTH}"
          DEPLOY_SCRIPT

          chmod +x /tmp/deploy-secure.sh

      # ============================================
      # 6. S3ì— íŒŒì¼ ì—…ë¡œë“œ
      # ============================================
      - name: ğŸ“¤ Upload to S3
        run: |
          BUCKET_NAME="wealist-deploy-scripts"
          aws s3 mb s3://${BUCKET_NAME} --region ${{ env.AWS_REGION }} 2>/dev/null || true
          aws s3 cp /tmp/docker-compose.yml s3://${BUCKET_NAME}/docker-compose.yml
          aws s3 cp /tmp/deploy-secure.sh s3://${BUCKET_NAME}/deploy-secure.sh

      # ============================================
      # 7. SSMìœ¼ë¡œ EC2ì— ë°°í¬
      # ============================================
      - name: ğŸš€ Deploy via SSM
        run: |
          INSTANCE_ID="${{ secrets.EC2_INSTANCE_ID }}"
          BUCKET_NAME="wealist-deploy-scripts"

          echo "ğŸš€ Executing secure deployment on ${INSTANCE_ID}"

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${INSTANCE_ID}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "set -e",
              "cd /home/ec2-user/wealist-deploy || mkdir -p /home/ec2-user/wealist-deploy",
              "cd /home/ec2-user/wealist-deploy",
              "aws s3 cp s3://'\"${BUCKET_NAME}\"'/docker-compose.yml ./docker-compose.yml",
              "aws s3 cp s3://'\"${BUCKET_NAME}\"'/deploy-secure.sh ./deploy-secure.sh",
              "chmod +x ./deploy-secure.sh",
              "sudo -u ec2-user bash ./deploy-secure.sh"
            ]' \
            --region ${{ env.AWS_REGION }} \
            --output text \
            --query 'Command.CommandId')

          echo "Command ID: ${COMMAND_ID}"

          # ëª…ë ¹ ì™„ë£Œ ëŒ€ê¸°
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "${COMMAND_ID}" \
              --instance-id "${INSTANCE_ID}" \
              --region ${{ env.AWS_REGION }} \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")

            echo "[$(date +%H:%M:%S)] Status: ${STATUS}"

            if [ "${STATUS}" == "Success" ]; then
              echo "âœ… Deployment completed!"
              aws ssm get-command-invocation \
                --command-id "${COMMAND_ID}" \
                --instance-id "${INSTANCE_ID}" \
                --region ${{ env.AWS_REGION }} \
                --query 'StandardOutputContent' \
                --output text
              exit 0
            elif [ "${STATUS}" == "Failed" ]; then
              echo "âŒ Deployment failed!"
              aws ssm get-command-invocation \
                --command-id "${COMMAND_ID}" \
                --instance-id "${INSTANCE_ID}" \
                --region ${{ env.AWS_REGION }} \
                --query 'StandardErrorContent' \
                --output text
              exit 1
            fi

            sleep 10
          done

          echo "âš ï¸ Timeout"
          exit 1

      # ============================================
      # 8. ë°°í¬ ê²°ê³¼ ìš”ì•½
      # ============================================
      - name: ğŸ“‹ Deployment Summary
        if: always()
        run: |
          echo "### ğŸ”’ Secure Deployment Complete (OIDC)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Security Method:** AWS OIDC + Parameter Store âœ…" >> $GITHUB_STEP_SUMMARY
          echo "**Authentication:** Temporary credentials (no Access Keys) âœ…" >> $GITHUB_STEP_SUMMARY
          echo "**Instance ID:** \`${{ secrets.EC2_INSTANCE_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Security Features:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No long-lived credentials in GitHub" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Temporary AWS credentials (1 hour validity)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Repository + Branch restricted access" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Secrets stored in AWS Parameter Store" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… .env file secured with 600 permissions" >> $GITHUB_STEP_SUMMARY

# ============================================
# ê¸°ì¡´ ì›Œí¬í”Œë¡œìš°ì™€ì˜ ì°¨ì´ì 
# ============================================

# ê¸°ì¡´ (dev-backend-deploy-secure.yml):
# - uses: aws-actions/configure-aws-credentials@v4
#   with:
#     aws-access-key-id: ${{ secrets.WEALIST_DEV_AWS_ACCESS_KEY_ID }}      # âŒ ì¥ê¸° ìê²©ì¦ëª…
#     aws-secret-access-key: ${{ secrets.WEALIST_DEV_AWS_SECRET_ACCESS_KEY }}  # âŒ ì¥ê¸° ìê²©ì¦ëª…

# ê°œì„  (ì´ íŒŒì¼):
# - uses: aws-actions/configure-aws-credentials@v4
#   with:
#     role-to-assume: arn:aws:iam::ACCOUNT_ID:role/GitHubActionsDeployRole  # âœ… OIDC ì„ì‹œ ìê²©ì¦ëª…

# ============================================
# í•„ìš”í•œ GitHub Secrets (ìµœì†Œí™”)
# ============================================

# âœ… WEALIST_DEV_AWS_ACCOUNT_ID   - AWS ê³„ì • ID (12ìë¦¬)
# âœ… EC2_INSTANCE_ID               - EC2 ì¸ìŠ¤í„´ìŠ¤ ID (i-xxxxxx)

# âŒ ì œê±° ê°€ëŠ¥:
# WEALIST_DEV_AWS_ACCESS_KEY_ID      - OIDCë¡œ ëŒ€ì²´
# WEALIST_DEV_AWS_SECRET_ACCESS_KEY  - OIDCë¡œ ëŒ€ì²´
