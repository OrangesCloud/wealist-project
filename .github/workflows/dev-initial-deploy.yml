name: Initial Deployment - All Services

on:
  # ìˆ˜ë™ ì‹¤í–‰ ì „ìš© (ìµœì´ˆ ë°°í¬ ë˜ëŠ” ì „ì²´ ìž¬ë°°í¬ ì‹œ ì‚¬ìš©)
  workflow_dispatch:
    inputs:
      deploy_to_ec2:
        description: 'EC2ì— ìžë™ ë°°í¬í• ê¹Œìš”?'
        required: true
        type: boolean
        default: true

env:
  AWS_REGION: ap-northeast-2

jobs:
  # ==================================================
  # Job 1: User Service ë¹Œë“œ & ECR í‘¸ì‹œ
  # ==================================================
  build-user-service:
    name: Build User Service
    runs-on: ubuntu-latest
    environment: development

    outputs:
      image-tag: ${{ steps.image-info.outputs.image-tag }}
      full-image: ${{ steps.image-info.outputs.full-image }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "gradle"

      - name: ðŸ”¨ Build with Gradle
        run: |
          cd user-service
          chmod +x gradlew
          ./gradlew clean build

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ·ï¸ Generate Image Tags
        id: image-info
        run: |
          ECR_REGISTRY="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          IMAGE_TAG="${GITHUB_SHA:0:7}"
          FULL_IMAGE="${ECR_REGISTRY}/wealist-dev-user-service:${IMAGE_TAG}"
          LATEST_IMAGE="${ECR_REGISTRY}/wealist-dev-user-service:latest"

          echo "ecr-registry=${ECR_REGISTRY}" >> $GITHUB_OUTPUT
          echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "full-image=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          echo "latest-image=${LATEST_IMAGE}" >> $GITHUB_OUTPUT

      - name: ðŸ³ Login to ECR, Build and Push
        env:
          FULL_IMAGE: ${{ steps.image-info.outputs.full-image }}
          LATEST_IMAGE: ${{ steps.image-info.outputs.latest-image }}
          ECR_REGISTRY: ${{ steps.image-info.outputs.ecr-registry }}
        run: |
          # ECR ë¡œê·¸ì¸
          echo "ðŸ”‘ Logging into Amazon ECR..."
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin ${ECR_REGISTRY}

          # Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
          cd user-service
          docker build --build-arg CACHEBUST=$(date +%s) -t ${FULL_IMAGE} -t ${LATEST_IMAGE} .
          docker push ${FULL_IMAGE}
          docker push ${LATEST_IMAGE}
          echo "âœ… User Service: ${LATEST_IMAGE}"

  # ==================================================
  # Job 2: Board Service ë¹Œë“œ & ECR í‘¸ì‹œ
  # ==================================================
  build-board-service:
    name: Build Board Service
    runs-on: ubuntu-latest
    environment: development

    outputs:
      image-tag: ${{ steps.image-info.outputs.image-tag }}
      full-image: ${{ steps.image-info.outputs.full-image }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Go Environment
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: true
          cache-dependency-path: board-service/go.sum

      - name: ðŸ“¦ Download Go Dependencies
        run: |
          cd board-service
          go mod tidy
          go mod download

      - name: ðŸ§ª Run Go Tests
        continue-on-error: true  # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
        run: |
          cd board-service
          go test -v -race -cover ./... || echo "âš ï¸ Tests failed but continuing build"

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ·ï¸ Generate Image Tags
        id: image-info
        run: |
          ECR_REGISTRY="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          IMAGE_TAG="${GITHUB_SHA:0:7}"
          FULL_IMAGE="${ECR_REGISTRY}/wealist-dev-board-service:${IMAGE_TAG}"
          LATEST_IMAGE="${ECR_REGISTRY}/wealist-dev-board-service:latest"

          echo "ecr-registry=${ECR_REGISTRY}" >> $GITHUB_OUTPUT
          echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "full-image=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          echo "latest-image=${LATEST_IMAGE}" >> $GITHUB_OUTPUT

      - name: ðŸ³ Login to ECR, Build and Push
        env:
          FULL_IMAGE: ${{ steps.image-info.outputs.full-image }}
          LATEST_IMAGE: ${{ steps.image-info.outputs.latest-image }}
          ECR_REGISTRY: ${{ steps.image-info.outputs.ecr-registry }}
        run: |
          # ECR ë¡œê·¸ì¸
          echo "ðŸ”‘ Logging into Amazon ECR..."
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin ${ECR_REGISTRY}

          # Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
          cd board-service
          docker build -f docker/Dockerfile -t ${FULL_IMAGE} -t ${LATEST_IMAGE} .
          docker push ${FULL_IMAGE}
          docker push ${LATEST_IMAGE}
          echo "âœ… Board Service: ${LATEST_IMAGE}"

  # ==================================================
  # Job 3: EC2 ë°°í¬ (ì„ íƒì )
  # ==================================================
  deploy-to-ec2:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    environment: development
    needs: [build-user-service, build-board-service]  # ë‘ ë¹Œë“œ ì™„ë£Œ í›„ ì‹¤í–‰
    if: ${{ inputs.deploy_to_ec2 }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

      - name: ðŸ“ Add EC2 to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ“¤ Copy Docker Compose Files to EC2
        run: |
          ssh ec2-user@${{ secrets.EC2_HOST }} "mkdir -p ~/wealist-deploy"

          scp docker/compose/docker-compose.ec2-dev.yml \
            ec2-user@${{ secrets.EC2_HOST }}:~/wealist-deploy/docker-compose.yml

      - name: ðŸ”§ Create Environment File on EC2
        run: |
          ssh ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            cat > ~/wealist-deploy/.env << ENVFILE
          # Application
          APP_NAME=wealist-api
          VERSION=latest

          # AWS
          AWS_REGION=${{ env.AWS_REGION }}
          AWS_ACCOUNT_ID=${{ secrets.AWS_ACCOUNT_ID }}

          # Database - User Service
          USER_DB_NAME=${{ secrets.USER_DB_NAME }}
          USER_DB_USER=${{ secrets.USER_DB_USER }}
          USER_DB_PASSWORD=${{ secrets.USER_DB_PASSWORD }}

          # Database - Board Service
          BOARD_DB_NAME=${{ secrets.BOARD_DB_NAME }}
          BOARD_DB_USER=${{ secrets.BOARD_DB_USER }}
          BOARD_DB_PASSWORD=${{ secrets.BOARD_DB_PASSWORD }}

          # Database - Superuser
          POSTGRES_SUPERUSER=${{ secrets.POSTGRES_SUPERUSER }}
          POSTGRES_SUPERUSER_PASSWORD=${{ secrets.POSTGRES_SUPERUSER_PASSWORD }}

          # Redis
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}

          # JWT
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_ACCESS_TOKEN_EXPIRATION_MS=1800000
          JWT_REFRESH_TOKEN_EXPIRATION_MS=604800000

          # OAuth
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}

          # Service Configuration
          JPA_DDL_AUTO=update
          JPA_SHOW_SQL=true
          JPA_FORMAT_SQL=true
          LOG_LEVEL=debug

          # CORS
          CORS_ORIGINS=*

          # Monitoring
          GRAFANA_ADMIN_USER=admin
          GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}
          ENVFILE
          EOF

      - name: ðŸš€ Deploy to EC2
        run: |
          ssh ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/wealist-deploy

            echo "ðŸ” Logging into Amazon ECR..."
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
              docker login --username AWS --password-stdin \
              ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com

            echo "ðŸ“¥ Pulling latest images from ECR..."
            docker compose --env-file .env pull

            echo "ðŸ”„ Starting services..."
            docker compose --env-file .env up -d --remove-orphans

            echo "âœ… Deployment Complete!"
            docker compose --env-file .env ps
          EOF

      - name: ðŸ¥ Health Check
        run: |
          ssh ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            echo "â³ Waiting for services to start (30s)..."
            sleep 30

            echo "ðŸ¥ Health Check - User Service"
            curl -f http://localhost:8080/actuator/health || echo "âš ï¸ User Service not ready"

            echo "ðŸ¥ Health Check - Board Service"
            curl -f http://localhost:8000/health || echo "âš ï¸ Board Service not ready"

            echo "ðŸ“Š Service Status:"
            docker compose --env-file ~/wealist-deploy/.env ps
          EOF

      - name: ðŸ“‹ Deployment Summary
        run: |
          echo "### ðŸš€ Initial Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**User Service Image:** \`${{ needs.build-user-service.outputs.full-image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Board Service Image:** \`${{ needs.build-board-service.outputs.full-image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services:**" >> $GITHUB_STEP_SUMMARY
          echo "- User Service: http://${{ secrets.EC2_HOST }}:8080" >> $GITHUB_STEP_SUMMARY
          echo "- Board Service: http://${{ secrets.EC2_HOST }}:8000" >> $GITHUB_STEP_SUMMARY
          echo "- Grafana: http://${{ secrets.EC2_HOST }}:3001" >> $GITHUB_STEP_SUMMARY
