name: Initial Deployment - All Services

on:
  # ìˆ˜ë™ ì‹¤í–‰ ì „ìš© (ìµœì´ˆ ë°°í¬ ë˜ëŠ” ì „ì²´ ìž¬ë°°í¬ ì‹œ ì‚¬ìš©)
  workflow_dispatch:
    inputs:
      deploy_to_ec2:
        description: 'EC2ì— ìžë™ ë°°í¬í• ê¹Œìš”?'
        required: true
        type: boolean
        default: true

env:
  AWS_REGION: ap-northeast-2

jobs:
  # ==================================================
  # Job 1: User Service ë¹Œë“œ & ECR í‘¸ì‹œ
  # ==================================================
  build-user-service:
    name: Build User Service
    runs-on: ubuntu-latest
    environment: development

    outputs:
      image-tag: ${{ steps.image-info.outputs.image-tag }}
      full-image: ${{ steps.image-info.outputs.full-image }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "gradle"

      - name: ðŸ”¨ Build with Gradle
        run: |
          cd user-service
          chmod +x gradlew
          ./gradlew clean build

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.WEALIST_DEV_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.WEALIST_DEV_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ·ï¸ Generate Image Tags
        id: image-info
        run: |
          ECR_REGISTRY="${{ secrets.WEALIST_DEV_AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          IMAGE_TAG="${GITHUB_SHA:0:7}"
          FULL_IMAGE="${ECR_REGISTRY}/wealist-dev-user-service:${IMAGE_TAG}"
          LATEST_IMAGE="${ECR_REGISTRY}/wealist-dev-user-service:latest"

          echo "ecr-registry=${ECR_REGISTRY}" >> $GITHUB_OUTPUT
          echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "full-image=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          echo "latest-image=${LATEST_IMAGE}" >> $GITHUB_OUTPUT

      - name: ðŸ³ Login to ECR, Build and Push
        env:
          FULL_IMAGE: ${{ steps.image-info.outputs.full-image }}
          LATEST_IMAGE: ${{ steps.image-info.outputs.latest-image }}
          ECR_REGISTRY: ${{ steps.image-info.outputs.ecr-registry }}
        run: |
          # ECR ë¡œê·¸ì¸
          echo "ðŸ”‘ Logging into Amazon ECR..."
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin ${ECR_REGISTRY}

          # Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
          cd user-service
          docker build --build-arg CACHEBUST=$(date +%s) -t ${FULL_IMAGE} -t ${LATEST_IMAGE} .
          docker push ${FULL_IMAGE}
          docker push ${LATEST_IMAGE}
          echo "âœ… User Service: ${LATEST_IMAGE}"

  # ==================================================
  # Job 2: Board Service ë¹Œë“œ & ECR í‘¸ì‹œ
  # ==================================================
  build-board-service:
    name: Build Board Service
    runs-on: ubuntu-latest
    environment: development

    outputs:
      image-tag: ${{ steps.image-info.outputs.image-tag }}
      full-image: ${{ steps.image-info.outputs.full-image }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Go Environment
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: true
          cache-dependency-path: board-service/go.sum

      - name: ðŸ“¦ Download Go Dependencies
        run: |
          cd board-service
          go mod tidy
          go mod download

      - name: ðŸ§ª Run Go Tests
        continue-on-error: true  # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
        run: |
          cd board-service
          go test -v -race -cover ./... || echo "âš ï¸ Tests failed but continuing build"

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.WEALIST_DEV_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.WEALIST_DEV_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ·ï¸ Generate Image Tags
        id: image-info
        run: |
          ECR_REGISTRY="${{ secrets.WEALIST_DEV_AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          IMAGE_TAG="${GITHUB_SHA:0:7}"
          FULL_IMAGE="${ECR_REGISTRY}/wealist-dev-board-service:${IMAGE_TAG}"
          LATEST_IMAGE="${ECR_REGISTRY}/wealist-dev-board-service:latest"

          echo "ecr-registry=${ECR_REGISTRY}" >> $GITHUB_OUTPUT
          echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "full-image=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          echo "latest-image=${LATEST_IMAGE}" >> $GITHUB_OUTPUT

      - name: ðŸ³ Login to ECR, Build and Push
        env:
          FULL_IMAGE: ${{ steps.image-info.outputs.full-image }}
          LATEST_IMAGE: ${{ steps.image-info.outputs.latest-image }}
          ECR_REGISTRY: ${{ steps.image-info.outputs.ecr-registry }}
        run: |
          # ECR ë¡œê·¸ì¸
          echo "ðŸ”‘ Logging into Amazon ECR..."
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin ${ECR_REGISTRY}

          # Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
          cd board-service
          docker build -f docker/Dockerfile -t ${FULL_IMAGE} -t ${LATEST_IMAGE} .
          docker push ${FULL_IMAGE}
          docker push ${LATEST_IMAGE}
          echo "âœ… Board Service: ${LATEST_IMAGE}"

  # ==================================================
  # Job 3: EC2 ë°°í¬ (SSM ë°©ì‹ - ë³´ì•ˆ ê°•í™”)
  # ==================================================
  deploy-to-ec2:
    name: Deploy to EC2 via SSM
    runs-on: ubuntu-latest
    environment: development
    needs: [build-user-service, build-board-service]  # ë‘ ë¹Œë“œ ì™„ë£Œ í›„ ì‹¤í–‰
    if: ${{ inputs.deploy_to_ec2 }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.WEALIST_DEV_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.WEALIST_DEV_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ“‹ Prepare Docker Compose File
        run: |
          cat docker/compose/docker-compose.ec2-dev.yml > /tmp/docker-compose.yml
          echo "Docker Compose file prepared"

      - name: ðŸ“ Create Deployment Script (Parameter Store)
        env:
          AWS_ACCOUNT_ID: ${{ secrets.WEALIST_DEV_AWS_ACCOUNT_ID }}
        run: |
          cat > /tmp/deploy.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e

          AWS_REGION="ap-northeast-2"

          echo "=========================================="
          echo "ðŸš€ Starting Initial Deployment"
          echo "=========================================="

          # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ~/wealist-deploy
          cd ~/wealist-deploy

          # ============================================
          # Parameter Storeì—ì„œ í™˜ê²½ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸°
          # ============================================
          echo "ðŸ“¥ Fetching secrets from Parameter Store..."

          # Helper function to get parameter
          get_parameter() {
            aws ssm get-parameter \
              --name "$1" \
              --with-decryption \
              --region ${AWS_REGION} \
              --query 'Parameter.Value' \
              --output text 2>/dev/null || echo ""
          }

          # Fetch all parameters
          POSTGRES_SUPERUSER=$(get_parameter "/wealist/dev/postgres-superuser")
          POSTGRES_SUPERUSER_PASSWORD=$(get_parameter "/wealist/dev/postgres-superuser-password")
          USER_DB_NAME=$(get_parameter "/wealist/dev/user-db-name")
          USER_DB_USER=$(get_parameter "/wealist/dev/user-db-user")
          USER_DB_PASSWORD=$(get_parameter "/wealist/dev/user-db-password")
          BOARD_DB_NAME=$(get_parameter "/wealist/dev/board-db-name")
          BOARD_DB_USER=$(get_parameter "/wealist/dev/board-db-user")
          BOARD_DB_PASSWORD=$(get_parameter "/wealist/dev/board-db-password")
          REDIS_PASSWORD=$(get_parameter "/wealist/dev/redis-password")
          JWT_SECRET=$(get_parameter "/wealist/dev/jwt-secret")
          GOOGLE_CLIENT_ID=$(get_parameter "/wealist/dev/google-client-id")
          GOOGLE_CLIENT_SECRET=$(get_parameter "/wealist/dev/google-client-secret")
          GRAFANA_ADMIN_USER=$(get_parameter "/wealist/dev/grafana-admin-user")
          GRAFANA_ADMIN_PASSWORD=$(get_parameter "/wealist/dev/grafana-admin-password")

          # Validation: Check critical parameters
          if [[ -z "$POSTGRES_SUPERUSER_PASSWORD" ]] || [[ -z "$JWT_SECRET" ]]; then
            echo "âŒ Error: Failed to fetch critical parameters from Parameter Store"
            echo "Please verify:"
            echo "  1. EC2 Instance Profile is attached"
            echo "  2. Parameters exist in Parameter Store"
            echo "  3. IAM permissions are correct"
            exit 1
          fi

          echo "âœ… Successfully fetched all parameters"

          # ============================================
          # .env íŒŒì¼ ìƒì„± (ë™ì ìœ¼ë¡œ)
          # ============================================
          cat > .env << 'ENVFILE'
APP_NAME=wealist-api
VERSION=latest
AWS_REGION=\${AWS_REGION}
AWS_ACCOUNT_ID=\${AWS_ACCOUNT_ID}
POSTGRES_SUPERUSER=\${POSTGRES_SUPERUSER}
POSTGRES_SUPERUSER_PASSWORD=\${POSTGRES_SUPERUSER_PASSWORD}
USER_DB_NAME=\${USER_DB_NAME}
USER_DB_USER=\${USER_DB_USER}
USER_DB_PASSWORD=\${USER_DB_PASSWORD}
BOARD_DB_NAME=\${BOARD_DB_NAME}
BOARD_DB_USER=\${BOARD_DB_USER}
BOARD_DB_PASSWORD=\${BOARD_DB_PASSWORD}
REDIS_PASSWORD=\${REDIS_PASSWORD}
JWT_SECRET=\${JWT_SECRET}
JWT_ACCESS_TOKEN_EXPIRATION_MS=1800000
JWT_REFRESH_TOKEN_EXPIRATION_MS=604800000
GOOGLE_CLIENT_ID=\${GOOGLE_CLIENT_ID}
GOOGLE_CLIENT_SECRET=\${GOOGLE_CLIENT_SECRET}
JPA_DDL_AUTO=update
JPA_SHOW_SQL=true
JPA_FORMAT_SQL=true
LOG_LEVEL=debug
CORS_ORIGINS=*
GRAFANA_ADMIN_USER=\${GRAFANA_ADMIN_USER}
GRAFANA_ADMIN_PASSWORD=\${GRAFANA_ADMIN_PASSWORD}
ENVFILE

          # í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜
          sed -i "s/\\\${AWS_REGION}/${AWS_REGION}/g" .env
          sed -i "s/\\\${AWS_ACCOUNT_ID}/${AWS_ACCOUNT_ID}/g" .env
          sed -i "s/\\\${POSTGRES_SUPERUSER}/${POSTGRES_SUPERUSER}/g" .env
          sed -i "s/\\\${POSTGRES_SUPERUSER_PASSWORD}/${POSTGRES_SUPERUSER_PASSWORD}/g" .env
          sed -i "s/\\\${USER_DB_NAME}/${USER_DB_NAME}/g" .env
          sed -i "s/\\\${USER_DB_USER}/${USER_DB_USER}/g" .env
          sed -i "s/\\\${USER_DB_PASSWORD}/${USER_DB_PASSWORD}/g" .env
          sed -i "s/\\\${BOARD_DB_NAME}/${BOARD_DB_NAME}/g" .env
          sed -i "s/\\\${BOARD_DB_USER}/${BOARD_DB_USER}/g" .env
          sed -i "s/\\\${BOARD_DB_PASSWORD}/${BOARD_DB_PASSWORD}/g" .env
          sed -i "s/\\\${REDIS_PASSWORD}/${REDIS_PASSWORD}/g" .env
          sed -i "s/\\\${JWT_SECRET}/${JWT_SECRET}/g" .env
          sed -i "s/\\\${GOOGLE_CLIENT_ID}/${GOOGLE_CLIENT_ID}/g" .env
          sed -i "s/\\\${GOOGLE_CLIENT_SECRET}/${GOOGLE_CLIENT_SECRET}/g" .env
          sed -i "s/\\\${GRAFANA_ADMIN_USER}/${GRAFANA_ADMIN_USER}/g" .env
          sed -i "s/\\\${GRAFANA_ADMIN_PASSWORD}/${GRAFANA_ADMIN_PASSWORD}/g" .env

          echo "âœ… Environment file created"

          # ECR ë¡œê·¸ì¸
          echo "ðŸ”‘ Logging into Amazon ECR..."
          aws ecr get-login-password --region ${AWS_REGION} | \
            docker login --username AWS --password-stdin \
            ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

          # ìµœì‹  ì´ë¯¸ì§€ Pull
          echo "ðŸ“¥ Pulling latest images from ECR..."
          docker compose pull

          # ì„œë¹„ìŠ¤ ì‹œìž‘
          echo "ðŸ”„ Starting all services..."
          docker compose up -d --remove-orphans

          # êµ¬ ì´ë¯¸ì§€ ì •ë¦¬
          echo "ðŸ§¹ Cleaning up old images..."
          docker image prune -f

          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo ""
          echo "=========================================="
          echo "âœ… Initial Deployment Complete!"
          echo "=========================================="
          docker compose ps

          # Health Check
          echo ""
          echo "ðŸ¥ Running Health Checks..."
          sleep 45

          echo "Checking User Service..."
          curl -f http://localhost:8080/actuator/health || echo "âš ï¸ User Service not ready yet"

          echo "Checking Board Service..."
          curl -f http://localhost:8000/health || echo "âš ï¸ Board Service not ready yet"

          echo ""
          echo "=========================================="
          echo "ðŸ“Š Final Service Status"
          echo "=========================================="
          docker compose ps
          DEPLOY_SCRIPT

          # AWS_ACCOUNT_IDë¥¼ ìŠ¤í¬ë¦½íŠ¸ì— ì£¼ìž…
          sed -i "s/\${AWS_ACCOUNT_ID}/$AWS_ACCOUNT_ID/g" /tmp/deploy.sh

          chmod +x /tmp/deploy.sh
          echo "âœ… Deployment script created with Parameter Store integration"

      - name: ðŸ“¤ Upload Files to S3
        run: |
          BUCKET_NAME="wealist-deploy-scripts"

          # S3 ë²„í‚·ì´ ì—†ìœ¼ë©´ ìƒì„± (ì—ëŸ¬ ë¬´ì‹œ)
          aws s3 mb s3://${BUCKET_NAME} --region ${{ env.AWS_REGION }} 2>/dev/null || true

          # íŒŒì¼ ì—…ë¡œë“œ
          aws s3 cp /tmp/docker-compose.yml s3://${BUCKET_NAME}/docker-compose.yml
          aws s3 cp /tmp/deploy.sh s3://${BUCKET_NAME}/deploy.sh

          echo "Files uploaded to S3"

      - name: ðŸš€ Deploy via SSM
        run: |
          INSTANCE_ID="${{ secrets.EC2_INSTANCE_ID }}"
          BUCKET_NAME="wealist-deploy-scripts"

          echo "Executing initial deployment on EC2 instance: ${INSTANCE_ID}"

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${INSTANCE_ID}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "set -e",
              "cd /home/ec2-user/wealist-deploy || mkdir -p /home/ec2-user/wealist-deploy",
              "cd /home/ec2-user/wealist-deploy",
              "aws s3 cp s3://'"${BUCKET_NAME}"'/docker-compose.yml ./docker-compose.yml",
              "aws s3 cp s3://'"${BUCKET_NAME}"'/deploy.sh ./deploy.sh",
              "chmod +x ./deploy.sh",
              "bash ./deploy.sh"
            ]' \
            --region ${{ env.AWS_REGION }} \
            --output text \
            --query 'Command.CommandId')

          echo "Command ID: ${COMMAND_ID}"
          echo "Waiting for command to complete..."

          # ëª…ë ¹ ì‹¤í–‰ ì™„ë£Œ ëŒ€ê¸° (ìµœëŒ€ 15ë¶„ - ì´ˆê¸° ë°°í¬ëŠ” ì‹œê°„ì´ ë” ê±¸ë¦¼)
          for i in {1..90}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "${COMMAND_ID}" \
              --instance-id "${INSTANCE_ID}" \
              --region ${{ env.AWS_REGION }} \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")

            echo "Status: ${STATUS}"

            if [ "${STATUS}" == "Success" ]; then
              echo "âœ… Initial deployment completed successfully!"

              # ì¶œë ¥ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°
              aws ssm get-command-invocation \
                --command-id "${COMMAND_ID}" \
                --instance-id "${INSTANCE_ID}" \
                --region ${{ env.AWS_REGION }} \
                --query 'StandardOutputContent' \
                --output text

              exit 0
            elif [ "${STATUS}" == "Failed" ]; then
              echo "âŒ Initial deployment failed!"

              # ì—ëŸ¬ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°
              aws ssm get-command-invocation \
                --command-id "${COMMAND_ID}" \
                --instance-id "${INSTANCE_ID}" \
                --region ${{ env.AWS_REGION }} \
                --query 'StandardErrorContent' \
                --output text

              exit 1
            fi

            sleep 10
          done

          echo "âš ï¸ Deployment timeout after 15 minutes"
          exit 1

      - name: ðŸ“‹ Deployment Summary
        if: always()
        run: |
          echo "### ðŸš€ Initial Deployment Complete (SSM)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Development (EC2)" >> $GITHUB_STEP_SUMMARY
          echo "**Instance ID:** \`${{ secrets.EC2_INSTANCE_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**User Service Image:** \`${{ needs.build-user-service.outputs.full-image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Board Service Image:** \`${{ needs.build-board-service.outputs.full-image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Method:** AWS Systems Manager (SSM) âœ… Secure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** All secrets fetched from AWS Parameter Store" >> $GITHUB_STEP_SUMMARY
