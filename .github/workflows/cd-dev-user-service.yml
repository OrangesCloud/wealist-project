name: CD - Dev User Service

on:
  # 1. CI ÏÑ±Í≥µ Ïãú ÏûêÎèô Ïã§Ìñâ
  workflow_run:
    workflows: ["CI - Dev User Service"]
    types:
      - completed

  # 2. Ïù∏ÌîÑÎùº Î≥ÄÍ≤Ω Ïãú ÏßÅÏ†ë Ïã§Ìñâ
  push:
    branches:
      - deploy-dev
    paths:
      - "docker/compose/docker-compose.ec2-dev.yml"
      - ".github/workflows/cd-dev-user-service.yml"

  # 3. ÏàòÎèô Ïã§Ìñâ (Í∞ïÏ†ú Ïû¨Î∞∞Ìè¨)
  workflow_dispatch:
    inputs:
      reason:
        description: 'Î∞∞Ìè¨ ÏÇ¨Ïú† (ÏÑ†ÌÉù)'
        required: false
        type: string

env:
  AWS_REGION: ap-northeast-2
  PARAMETER_PREFIX: /wealist/dev
  COMPOSE_FILE: /home/ubuntu/wealist/docker/compose/docker-compose.ec2-dev.yml

jobs:
  deploy:
    name: Deploy to EC2 via SSM
    runs-on: ubuntu-latest
    # workflow_runÏù¥Î©¥ ÏÑ±Í≥µ ÌôïÏù∏, ÏïÑÎãàÎ©¥ Î∞îÎ°ú Ïã§Ìñâ
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    environment: development

    steps:
      # ============================================
      # 1. ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
      # ============================================
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      # ============================================
      # 2. AWS Credentials ÏÑ§Ï†ï
      # ============================================
      - name: üîê Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.WEALIST_DEV_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.WEALIST_DEV_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ============================================
      # 3. ECR Î°úÍ∑∏Ïù∏
      # ============================================
      - name: üîë Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ============================================
      # 4. Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Ï§ÄÎπÑ (SSMÏúºÎ°ú Ïã§Ìñâ)
      # ============================================
      - name: üìù Prepare Deployment Script
        id: script
        run: |
          # AWS Account ID ÏûêÎèô Í∞êÏßÄ
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "aws-account-id=${AWS_ACCOUNT_ID}" >> $GITHUB_OUTPUT

          cat > /tmp/deploy-user.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e

          echo "=========================================="
          echo "üöÄ User Service Deployment Started"
          echo "=========================================="

          # ============================================
          # ÌîÑÎ°úÏ†ùÌä∏ Í≤ΩÎ°ú ÏÑ§Ï†ï Î∞è ÌôïÏù∏
          # ============================================
          PROJECT_DIR="/home/ubuntu/wealist"
          COMPOSE_FILE="${PROJECT_DIR}/docker/compose/docker-compose.ec2-dev.yml"

          # ÌîÑÎ°úÏ†ùÌä∏ ÎîîÎ†âÌÜ†Î¶¨Í∞Ä ÏóÜÏúºÎ©¥ ÌÅ¥Î°†
          if [ ! -d "$PROJECT_DIR" ]; then
            echo "üì¶ Cloning project repository..."
            cd /home/ubuntu
            git clone https://github.com/OrangesCloud/wealist-project.git wealist
            cd wealist
          else
            echo "‚úÖ Project directory exists"
            cd "$PROJECT_DIR"
            git pull origin deploy-dev
          fi

          # docker-compose ÌååÏùº ÌôïÏù∏
          if [ ! -f "$COMPOSE_FILE" ]; then
            echo "‚ùå docker-compose.ec2-dev.yml not found!"
            exit 1
          fi

          # ============================================
          # AWS Account ID ÏûêÎèô Í∞êÏßÄ
          # ============================================
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          export AWS_ACCOUNT_ID

          # ============================================
          # Parameter StoreÏóêÏÑú ÌôòÍ≤ΩÎ≥ÄÏàò Î°úÎìú
          # ============================================
          echo "üîê Loading parameters from AWS Parameter Store..."

          # ÏàòÏ†ïÎêú Í≤ΩÎ°úÎ°ú ÌååÎùºÎØ∏ÌÑ∞ Î°úÎìú
          export BOARD_DB_NAME=$(aws ssm get-parameter --name "/wealist/dev/db/board-name" --query "Parameter.Value" --output text --region ap-northeast-2)
          export BOARD_DB_USER=$(aws ssm get-parameter --name "/wealist/dev/db/board-username" --query "Parameter.Value" --output text --region ap-northeast-2)
          export BOARD_DB_PASSWORD=$(aws ssm get-parameter --name "/wealist/dev/db/board-password" --with-decryption --query "Parameter.Value" --output text --region ap-northeast-2)

          export USER_DB_NAME=$(aws ssm get-parameter --name "/wealist/dev/db/user-name" --query "Parameter.Value" --output text --region ap-northeast-2)
          export USER_DB_USER=$(aws ssm get-parameter --name "/wealist/dev/db/user-username" --query "Parameter.Value" --output text --region ap-northeast-2)
          export USER_DB_PASSWORD=$(aws ssm get-parameter --name "/wealist/dev/db/user-password" --with-decryption --query "Parameter.Value" --output text --region ap-northeast-2)

          export POSTGRES_SUPERUSER=$(aws ssm get-parameter --name "/wealist/dev/postgres/superuser" --query "Parameter.Value" --output text --region ap-northeast-2)
          export POSTGRES_SUPERUSER_PASSWORD=$(aws ssm get-parameter --name "/wealist/dev/postgres/superuser-password" --with-decryption --query "Parameter.Value" --output text --region ap-northeast-2)

          export REDIS_PASSWORD=$(aws ssm get-parameter --name "/wealist/dev/redis/password" --with-decryption --query "Parameter.Value" --output text --region ap-northeast-2)
          export JWT_SECRET=$(aws ssm get-parameter --name "/wealist/dev/jwt/secret" --with-decryption --query "Parameter.Value" --output text --region ap-northeast-2)

          export GOOGLE_CLIENT_ID=$(aws ssm get-parameter --name "/wealist/dev/oauth/google-client-id" --query "Parameter.Value" --output text --region ap-northeast-2)
          export GOOGLE_CLIENT_SECRET=$(aws ssm get-parameter --name "/wealist/dev/oauth/google-client-secret" --with-decryption --query "Parameter.Value" --output text --region ap-northeast-2)

          export GRAFANA_ADMIN_USER=$(aws ssm get-parameter --name "/wealist/dev/grafana/admin-user" --query "Parameter.Value" --output text --region ap-northeast-2)
          export GRAFANA_ADMIN_PASSWORD=$(aws ssm get-parameter --name "/wealist/dev/grafana/admin-password" --with-decryption --query "Parameter.Value" --output text --region ap-northeast-2)

          echo "‚úÖ Parameters loaded successfully"

          # ============================================
          # ECR Î°úÍ∑∏Ïù∏
          # ============================================
          echo "üîë Logging in to Amazon ECR..."
          aws ecr get-login-password --region ap-northeast-2 | \
            docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.ap-northeast-2.amazonaws.com

          # ============================================
          # Docker Ïù¥ÎØ∏ÏßÄ Pull
          # ============================================
          echo "üì• Pulling latest Docker images..."
          docker pull ${AWS_ACCOUNT_ID}.dkr.ecr.ap-northeast-2.amazonaws.com/wealist-dev-user-service:latest

          # ============================================
          # Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ Î∞è Ï†úÍ±∞
          # ============================================
          echo "üõë Stopping existing containers..."
          docker compose -f ${COMPOSE_FILE} stop user-service || true
          docker compose -f ${COMPOSE_FILE} rm -f user-service || true

          # ============================================
          # ÏÉà Ïª®ÌÖåÏù¥ÎÑà ÏãúÏûë
          # ============================================
          echo "‚ñ∂Ô∏è  Starting new containers..."
          docker compose -f ${COMPOSE_FILE} up -d user-service

          # ============================================
          # Health Check (Spring BootÎäî ÏãúÏûëÏù¥ ÎäêÎ¶º)
          # ============================================
          echo "üè• Performing health check..."
          sleep 15  # Spring Boot Ï¥àÍ∏∞ ÏãúÏûë ÎåÄÍ∏∞

          MAX_RETRIES=15
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "‚úÖ User service is healthy!"
              docker image prune -f
              echo "‚úÖ Deployment completed successfully!"
              exit 0
            fi
            echo "‚è≥ Waiting for service... ($i/$MAX_RETRIES)"
            sleep 5
          done

          echo "‚ùå Health check failed!"
          docker compose -f ${COMPOSE_FILE} logs --tail=50 user-service
          exit 1
          DEPLOY_SCRIPT

          chmod +x /tmp/deploy-user.sh
          echo "‚úÖ Deployment script prepared"

      # ============================================
      # 5. SSM Run CommandÎ°ú Î∞∞Ìè¨ Ïã§Ìñâ
      # ============================================
      - name: üöÄ Deploy via SSM Run Command
        id: deploy
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters file:///dev/stdin \
            --region ${{ env.AWS_REGION }} \
            --output text \
            --query "Command.CommandId" << 'PARAMS'
          {
            "commands": [
              "#!/bin/bash",
              "set -e",
              "echo '=========================================='",
              "echo 'üöÄ User Service Deployment Started'",
              "echo '=========================================='",
              "",
              "# ÌîÑÎ°úÏ†ùÌä∏ Í≤ΩÎ°ú ÏÑ§Ï†ï",
              "PROJECT_DIR=\"/home/ubuntu/wealist\"",
              "COMPOSE_FILE=\"${PROJECT_DIR}/docker/compose/docker-compose.ec2-dev.yml\"",
              "",
              "# ÌîÑÎ°úÏ†ùÌä∏ ÎîîÎ†âÌÜ†Î¶¨ ÌôïÏù∏ Î∞è ÌÅ¥Î°†",
              "if [ ! -d \"$PROJECT_DIR\" ] || [ ! -d \"$PROJECT_DIR/.git\" ]; then",
              "  echo 'üì¶ Cloning project repository...'",
              "  rm -rf \"$PROJECT_DIR\"",
              "  cd /home/ubuntu",
              "  git clone https://github.com/OrangesCloud/wealist-project.git wealist",
              "  cd wealist",
              "else",
              "  echo '‚úÖ Project directory exists'",
              "  cd \"$PROJECT_DIR\"",
              "  git fetch origin deploy-dev",
              "  git reset --hard origin/deploy-dev",
              "  git clean -fd",
              "fi",
              "",
              "# AWS Account ID ÏûêÎèô Í∞êÏßÄ",
              "AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)",
              "export AWS_ACCOUNT_ID",
              "",
              "# Docker Compose Î™ÖÎ†πÏñ¥ Í≤∞Ï†ï (v2 Ïö∞ÏÑ†, v1 fallback)",
              "if docker compose version &> /dev/null; then",
              "  DOCKER_COMPOSE='docker compose'",
              "elif docker-compose --version &> /dev/null; then",
              "  DOCKER_COMPOSE='docker-compose'",
              "else",
              "  echo '‚ùå Docker Compose not found!'",
              "  exit 1",
              "fi",
              "echo \"‚úÖ Using: $DOCKER_COMPOSE\"",
              "",
              "# Parameter StoreÏóêÏÑú ÌôòÍ≤ΩÎ≥ÄÏàò Î°úÎìú",
              "echo 'üîê Loading parameters from AWS Parameter Store...'",
              "export BOARD_DB_NAME=$(aws ssm get-parameter --name \"/wealist/dev/db/board-name\" --query \"Parameter.Value\" --output text --region ap-northeast-2)",
              "export BOARD_DB_USER=$(aws ssm get-parameter --name \"/wealist/dev/db/board-username\" --query \"Parameter.Value\" --output text --region ap-northeast-2)",
              "export BOARD_DB_PASSWORD=$(aws ssm get-parameter --name \"/wealist/dev/db/board-password\" --with-decryption --query \"Parameter.Value\" --output text --region ap-northeast-2)",
              "export USER_DB_NAME=$(aws ssm get-parameter --name \"/wealist/dev/db/user-name\" --query \"Parameter.Value\" --output text --region ap-northeast-2)",
              "export USER_DB_USER=$(aws ssm get-parameter --name \"/wealist/dev/db/user-username\" --query \"Parameter.Value\" --output text --region ap-northeast-2)",
              "export USER_DB_PASSWORD=$(aws ssm get-parameter --name \"/wealist/dev/db/user-password\" --with-decryption --query \"Parameter.Value\" --output text --region ap-northeast-2)",
              "export POSTGRES_SUPERUSER=$(aws ssm get-parameter --name \"/wealist/dev/postgres/superuser\" --query \"Parameter.Value\" --output text --region ap-northeast-2)",
              "export POSTGRES_SUPERUSER_PASSWORD=$(aws ssm get-parameter --name \"/wealist/dev/postgres/superuser-password\" --with-decryption --query \"Parameter.Value\" --output text --region ap-northeast-2)",
              "export REDIS_PASSWORD=$(aws ssm get-parameter --name \"/wealist/dev/redis/password\" --with-decryption --query \"Parameter.Value\" --output text --region ap-northeast-2)",
              "export JWT_SECRET=$(aws ssm get-parameter --name \"/wealist/dev/jwt/secret\" --with-decryption --query \"Parameter.Value\" --output text --region ap-northeast-2)",
              "export GOOGLE_CLIENT_ID=$(aws ssm get-parameter --name \"/wealist/dev/oauth/google-client-id\" --query \"Parameter.Value\" --output text --region ap-northeast-2)",
              "export GOOGLE_CLIENT_SECRET=$(aws ssm get-parameter --name \"/wealist/dev/oauth/google-client-secret\" --with-decryption --query \"Parameter.Value\" --output text --region ap-northeast-2)",
              "export GRAFANA_ADMIN_USER=$(aws ssm get-parameter --name \"/wealist/dev/grafana/admin-user\" --query \"Parameter.Value\" --output text --region ap-northeast-2)",
              "export GRAFANA_ADMIN_PASSWORD=$(aws ssm get-parameter --name \"/wealist/dev/grafana/admin-password\" --with-decryption --query \"Parameter.Value\" --output text --region ap-northeast-2)",
              "echo '‚úÖ Parameters loaded successfully'",
              "",
              "# ECR Î°úÍ∑∏Ïù∏",
              "echo 'üîë Logging in to Amazon ECR...'",
              "aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.ap-northeast-2.amazonaws.com",
              "",
              "# Docker Ïù¥ÎØ∏ÏßÄ Pull",
              "echo 'üì• Pulling latest Docker images...'",
              "docker pull ${AWS_ACCOUNT_ID}.dkr.ecr.ap-northeast-2.amazonaws.com/wealist-dev-user-service:latest",
              "",
              "# Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ",
              "echo 'üõë Stopping existing containers...'",
              "$DOCKER_COMPOSE -f ${COMPOSE_FILE} stop user-service || true",
              "$DOCKER_COMPOSE -f ${COMPOSE_FILE} rm -f user-service || true",
              "",
              "# ÏÉà Ïª®ÌÖåÏù¥ÎÑà ÏãúÏûë (ÌôòÍ≤ΩÎ≥ÄÏàò ÏßÅÏ†ë Ï†ÑÎã¨)",
              "echo '‚ñ∂Ô∏è  Starting new containers...'",
              "AWS_ACCOUNT_ID=${AWS_ACCOUNT_ID} \\",
              "BOARD_DB_NAME=${BOARD_DB_NAME} \\",
              "BOARD_DB_USER=${BOARD_DB_USER} \\",
              "BOARD_DB_PASSWORD=${BOARD_DB_PASSWORD} \\",
              "USER_DB_NAME=${USER_DB_NAME} \\",
              "USER_DB_USER=${USER_DB_USER} \\",
              "USER_DB_PASSWORD=${USER_DB_PASSWORD} \\",
              "POSTGRES_SUPERUSER=${POSTGRES_SUPERUSER} \\",
              "POSTGRES_SUPERUSER_PASSWORD=${POSTGRES_SUPERUSER_PASSWORD} \\",
              "REDIS_PASSWORD=${REDIS_PASSWORD} \\",
              "JWT_SECRET=${JWT_SECRET} \\",
              "GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID} \\",
              "GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET} \\",
              "GRAFANA_ADMIN_USER=${GRAFANA_ADMIN_USER} \\",
              "GRAFANA_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD} \\",
              "$DOCKER_COMPOSE -f ${COMPOSE_FILE} up -d user-service",
              "",
              "# Health Check (Spring BootÎäî ÏãúÏûëÏù¥ ÎäêÎ¶º)",
              "echo 'üè• Performing health check...'",
              "sleep 15",
              "MAX_RETRIES=15",
              "for i in $(seq 1 $MAX_RETRIES); do",
              "  if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then",
              "    echo '‚úÖ User service is healthy!'",
              "    docker image prune -f",
              "    echo '‚úÖ Deployment completed successfully!'",
              "    exit 0",
              "  fi",
              "  echo \"‚è≥ Waiting for service... ($i/$MAX_RETRIES)\"",
              "  sleep 5",
              "done",
              "echo '‚ùå Health check failed!'",
              "$DOCKER_COMPOSE -f ${COMPOSE_FILE} logs --tail=50 user-service",
              "exit 1"
            ]
          }
          PARAMS
          )

          echo "command-id=${COMMAND_ID}" >> $GITHUB_OUTPUT
          echo "‚úÖ SSM Command ID: ${COMMAND_ID}"

          # Î™ÖÎ†π ÏôÑÎ£å ÎåÄÍ∏∞
          echo "‚è≥ Waiting for deployment to complete..."
          aws ssm wait command-executed \
            --command-id "${COMMAND_ID}" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --region ${{ env.AWS_REGION }}

          # Ïã§Ìñâ Í≤∞Í≥º ÌôïÏù∏
          STATUS=$(aws ssm get-command-invocation \
            --command-id "${COMMAND_ID}" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --query "Status" \
            --output text)

          if [ "$STATUS" != "Success" ]; then
            echo "‚ùå Deployment failed with status: $STATUS"
            aws ssm get-command-invocation \
              --command-id "${COMMAND_ID}" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --query "StandardErrorContent" \
              --output text
            exit 1
          fi

          echo "‚úÖ Deployment successful!"

      # ============================================
      # 6. Î∞∞Ìè¨ Î°úÍ∑∏ Ï∂úÎ†•
      # ============================================
      - name: üìã Show Deployment Logs
        if: always()
        run: |
          aws ssm get-command-invocation \
            --command-id "${{ steps.deploy.outputs.command-id }}" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --query "StandardOutputContent" \
            --output text

      # ============================================
      # 7. Summary
      # ============================================
      - name: üìä Deployment Summary
        run: |
          echo "### ‚úÖ User Service Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Instance:** \`${{ secrets.EC2_INSTANCE_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Command:** \`${{ steps.deploy.outputs.command-id }}\`" >> $GITHUB_STEP_SUMMARY
