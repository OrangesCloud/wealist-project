name: CD - Dev User Service

on:
  workflow_run:
    workflows: ["CI - Dev User Service"]
    types:
      - completed
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  PARAMETER_PREFIX: /wealist/dev
  COMPOSE_FILE: /home/ubuntu/wealist/docker/compose/docker-compose.ec2-dev.yml

jobs:
  deploy:
    name: Deploy to EC2 via SSM
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: development

    steps:
      # ============================================
      # 1. ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
      # ============================================
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      # ============================================
      # 2. AWS Credentials ÏÑ§Ï†ï
      # ============================================
      - name: üîê Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.WEALIST_DEV_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.WEALIST_DEV_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ============================================
      # 3. Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÉùÏÑ±
      # ============================================
      - name: üìù Prepare Deployment Script
        id: script
        run: |
          cat << 'DEPLOY_SCRIPT' > /tmp/deploy-user.sh
          #!/bin/bash
          set -euo pipefail

          echo "üöÄ Starting User Service Deployment..."

          PARAMETER_PREFIX="${{ env.PARAMETER_PREFIX }}"
          AWS_REGION="${{ env.AWS_REGION }}"
          COMPOSE_FILE="${{ env.COMPOSE_FILE }}"

          # Parameter Î°úÎìú Ìï®Ïàò
          load_param() {
            aws ssm get-parameter \
              --name "${PARAMETER_PREFIX}/$1" \
              --query 'Parameter.Value' \
              --output text \
              --region ${AWS_REGION} 2>/dev/null || echo ""
          }

          load_secret() {
            aws ssm get-parameter \
              --name "${PARAMETER_PREFIX}/$1" \
              --with-decryption \
              --query 'Parameter.Value' \
              --output text \
              --region ${AWS_REGION} 2>/dev/null || echo ""
          }

          echo "üì• Loading environment variables..."
          export AWS_ACCOUNT_ID=$(load_param "aws-account-id")
          export AWS_REGION="${AWS_REGION}"
          export VERSION="latest"
          export POSTGRES_SUPERUSER=$(load_param "postgres-superuser")
          export POSTGRES_SUPERUSER_PASSWORD=$(load_secret "postgres-superuser-password")
          export USER_DB_NAME=$(load_param "user-db-name")
          export USER_DB_USER=$(load_param "user-db-user")
          export USER_DB_PASSWORD=$(load_secret "user-db-password")
          export BOARD_DB_NAME=$(load_param "board-db-name")
          export BOARD_DB_USER=$(load_param "board-db-user")
          export BOARD_DB_PASSWORD=$(load_secret "board-db-password")
          export REDIS_PASSWORD=$(load_secret "redis-password")
          export JWT_SECRET=$(load_secret "jwt-secret")
          export JWT_ACCESS_TOKEN_EXPIRATION_MS="1800000"
          export JWT_REFRESH_TOKEN_EXPIRATION_MS="604800000"
          export GOOGLE_CLIENT_ID=$(load_param "google-client-id")
          export GOOGLE_CLIENT_SECRET=$(load_secret "google-client-secret")
          export GRAFANA_ADMIN_USER=$(load_param "grafana-admin-user")
          export GRAFANA_ADMIN_PASSWORD=$(load_secret "grafana-admin-password")
          echo "‚úÖ Environment variables loaded"

          echo "üîë Logging into ECR..."
          aws ecr get-login-password --region ${AWS_REGION} | \
            docker login --username AWS --password-stdin \
            ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

          echo "üì• Pulling latest user-service image..."
          docker pull ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/wealist-dev-user-service:latest

          echo "üîÑ Restarting user-service..."
          docker compose -f ${COMPOSE_FILE} up -d --no-deps --force-recreate user-service

          echo "üè• Health check..."
          sleep 15
          MAX_RETRIES=12
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -f -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "‚úÖ User Service is healthy!"
              docker image prune -f
              echo "‚úÖ Deployment completed!"
              exit 0
            fi
            echo "‚è≥ Waiting... ($i/$MAX_RETRIES)"
            sleep 5
          done

          echo "‚ùå Health check failed!"
          docker compose -f ${COMPOSE_FILE} logs --tail=50 user-service
          exit 1
          DEPLOY_SCRIPT

          chmod +x /tmp/deploy-user.sh

      # ============================================
      # 4. SSM Run Command Ïã§Ìñâ
      # ============================================
      - name: üöÄ Deploy via SSM
        id: deploy
        run: |
          SCRIPT_BASE64=$(base64 -w 0 /tmp/deploy-user.sh)

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy User Service - ${{ github.sha }}" \
            --parameters commands="[
              \"echo '${SCRIPT_BASE64}' | base64 -d > /tmp/deploy.sh\",
              \"chmod +x /tmp/deploy.sh\",
              \"/tmp/deploy.sh\",
              \"rm -f /tmp/deploy.sh\"
            ]" \
            --output text \
            --query "Command.CommandId")

          echo "command-id=${COMMAND_ID}" >> $GITHUB_OUTPUT

      # ============================================
      # 5. Í≤∞Í≥º ÎåÄÍ∏∞
      # ============================================
      - name: ‚è≥ Wait for Deployment
        run: |
          aws ssm wait command-executed \
            --command-id "${{ steps.deploy.outputs.command-id }}" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}"

          STATUS=$(aws ssm get-command-invocation \
            --command-id "${{ steps.deploy.outputs.command-id }}" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --query "Status" \
            --output text)

          [ "$STATUS" = "Success" ] || exit 1

      # ============================================
      # 6. Î°úÍ∑∏ Ï∂úÎ†•
      # ============================================
      - name: üìã Show Logs
        if: always()
        run: |
          aws ssm get-command-invocation \
            --command-id "${{ steps.deploy.outputs.command-id }}" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --query "StandardOutputContent" \
            --output text

