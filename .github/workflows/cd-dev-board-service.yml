name: CD - Dev Board Service

on:
  # 1. CI ì„±ê³µ ì‹œ ìë™ ì‹¤í–‰
  workflow_run:
    workflows: ["CI - Dev Board Service"]
    types:
      - completed

  # 2. ì¸í”„ë¼ ë³€ê²½ ì‹œ ì§ì ‘ ì‹¤í–‰
  push:
    branches:
      - deploy-dev
    paths:
      - "docker/compose/docker-compose.ec2-dev.yml"
      - ".github/workflows/cd-dev-board-service.yml"

  # 3. ìˆ˜ë™ ì‹¤í–‰ (ê°•ì œ ì¬ë°°í¬)
  workflow_dispatch:
    inputs:
      reason:
        description: 'ë°°í¬ ì‚¬ìœ  (ì„ íƒ)'
        required: false
        type: string

env:
  AWS_REGION: ap-northeast-2
  PARAMETER_PREFIX: /wealist/dev
  COMPOSE_FILE: /home/ubuntu/wealist/docker/compose/docker-compose.ec2-dev.yml

jobs:
  deploy:
    name: Deploy to EC2 via SSM
    runs-on: ubuntu-latest
    # workflow_runì´ë©´ ì„±ê³µ í™•ì¸, ì•„ë‹ˆë©´ ë°”ë¡œ ì‹¤í–‰
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    environment: development

    steps:
      # ============================================
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # ============================================
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # ============================================
      # 2. AWS Credentials ì„¤ì •
      # ============================================
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.WEALIST_DEV_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.WEALIST_DEV_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ============================================
      # 3. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
      # ============================================
      - name: ğŸ“ Prepare Deployment Script
        id: script
        run: |
          cat << 'DEPLOY_SCRIPT' > /tmp/deploy-board.sh
          #!/bin/bash
          set -euo pipefail

          echo "ğŸš€ Starting Board Service Deployment..."

          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          PARAMETER_PREFIX="${{ env.PARAMETER_PREFIX }}"
          AWS_REGION="${{ env.AWS_REGION }}"
          COMPOSE_FILE="${{ env.COMPOSE_FILE }}"

          # =============================================================================
          # Parameter Storeì—ì„œ í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
          # =============================================================================
          echo "ğŸ“¥ Loading environment variables from Parameter Store..."

          load_param() {
            aws ssm get-parameter \
              --name "${PARAMETER_PREFIX}/$1" \
              --query 'Parameter.Value' \
              --output text \
              --region ${AWS_REGION} 2>/dev/null || echo ""
          }

          load_secret() {
            aws ssm get-parameter \
              --name "${PARAMETER_PREFIX}/$1" \
              --with-decryption \
              --query 'Parameter.Value' \
              --output text \
              --region ${AWS_REGION} 2>/dev/null || echo ""
          }

          export AWS_ACCOUNT_ID=$(load_param "aws-account-id")
          export AWS_REGION="${AWS_REGION}"
          export VERSION="latest"

          # PostgreSQL
          export POSTGRES_SUPERUSER=$(load_param "postgres-superuser")
          export POSTGRES_SUPERUSER_PASSWORD=$(load_secret "postgres-superuser-password")

          # User DB
          export USER_DB_NAME=$(load_param "user-db-name")
          export USER_DB_USER=$(load_param "user-db-user")
          export USER_DB_PASSWORD=$(load_secret "user-db-password")

          # Board DB
          export BOARD_DB_NAME=$(load_param "board-db-name")
          export BOARD_DB_USER=$(load_param "board-db-user")
          export BOARD_DB_PASSWORD=$(load_secret "board-db-password")

          # Redis
          export REDIS_PASSWORD=$(load_secret "redis-password")

          # JWT
          export JWT_SECRET=$(load_secret "jwt-secret")
          export JWT_ACCESS_TOKEN_EXPIRATION_MS="1800000"
          export JWT_REFRESH_TOKEN_EXPIRATION_MS="604800000"

          # OAuth
          export GOOGLE_CLIENT_ID=$(load_param "google-client-id")
          export GOOGLE_CLIENT_SECRET=$(load_secret "google-client-secret")

          # Grafana
          export GRAFANA_ADMIN_USER=$(load_param "grafana-admin-user")
          export GRAFANA_ADMIN_PASSWORD=$(load_secret "grafana-admin-password")

          echo "âœ… Environment variables loaded"

          # =============================================================================
          # ECR ë¡œê·¸ì¸
          # =============================================================================
          echo "ğŸ”‘ Logging into Amazon ECR..."
          aws ecr get-login-password --region ${AWS_REGION} | \
            docker login --username AWS --password-stdin \
            ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

          # =============================================================================
          # ìµœì‹  ì´ë¯¸ì§€ Pull
          # =============================================================================
          echo "ğŸ“¥ Pulling latest board-service image..."
          docker pull ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/wealist-dev-board-service:latest

          # =============================================================================
          # Board Service ì¬ì‹œì‘
          # =============================================================================
          echo "ğŸ”„ Restarting board-service..."
          docker compose -f ${COMPOSE_FILE} up -d --no-deps --force-recreate board-service

          # =============================================================================
          # Health Check
          # =============================================================================
          echo "ğŸ¥ Performing health check..."
          sleep 10

          MAX_RETRIES=12
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -f -s http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… Board Service is healthy!"
              docker image prune -f
              echo "âœ… Deployment completed successfully!"
              exit 0
            fi
            echo "â³ Waiting for service... ($i/$MAX_RETRIES)"
            sleep 5
          done

          echo "âŒ Health check failed!"
          docker compose -f ${COMPOSE_FILE} logs --tail=50 board-service
          exit 1
          DEPLOY_SCRIPT

          chmod +x /tmp/deploy-board.sh
          echo "âœ… Deployment script prepared"

      # ============================================
      # 4. SSM Run Commandë¡œ ìŠ¤í¬ë¦½íŠ¸ ì „ì†¡ & ì‹¤í–‰
      # ============================================
      - name: ğŸš€ Deploy via SSM Run Command
        id: deploy
        run: |
          # ìŠ¤í¬ë¦½íŠ¸ë¥¼ Base64ë¡œ ì¸ì½”ë”©
          SCRIPT_BASE64=$(base64 -w 0 /tmp/deploy-board.sh)

          # ë°°í¬ ì‚¬ìœ  í™•ì¸
          DEPLOY_REASON="${{ github.event.inputs.reason || 'Auto deploy' }}"

          # SSM Run Command ì‹¤í–‰
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy Board Service - ${{ github.sha }} - ${DEPLOY_REASON}" \
            --parameters commands="[
              \"echo '${SCRIPT_BASE64}' | base64 -d > /tmp/deploy.sh\",
              \"chmod +x /tmp/deploy.sh\",
              \"/tmp/deploy.sh\",
              \"rm -f /tmp/deploy.sh\"
            ]" \
            --output text \
            --query "Command.CommandId")

          echo "command-id=${COMMAND_ID}" >> $GITHUB_OUTPUT
          echo "ğŸ“ Command ID: ${COMMAND_ID}"

      # ============================================
      # 5. ë°°í¬ ê²°ê³¼ ëŒ€ê¸°
      # ============================================
      - name: â³ Wait for Deployment
        run: |
          COMMAND_ID="${{ steps.deploy.outputs.command-id }}"
          INSTANCE_ID="${{ secrets.EC2_INSTANCE_ID }}"

          echo "â³ Waiting for deployment..."
          aws ssm wait command-executed \
            --command-id "${COMMAND_ID}" \
            --instance-id "${INSTANCE_ID}"

          STATUS=$(aws ssm get-command-invocation \
            --command-id "${COMMAND_ID}" \
            --instance-id "${INSTANCE_ID}" \
            --query "Status" \
            --output text)

          if [ "$STATUS" != "Success" ]; then
            echo "âŒ Deployment failed!"
            aws ssm get-command-invocation \
              --command-id "${COMMAND_ID}" \
              --instance-id "${INSTANCE_ID}" \
              --query "StandardErrorContent" \
              --output text
            exit 1
          fi

          echo "âœ… Deployment successful!"

      # ============================================
      # 6. ë°°í¬ ë¡œê·¸ ì¶œë ¥
      # ============================================
      - name: ğŸ“‹ Show Deployment Logs
        if: always()
        run: |
          aws ssm get-command-invocation \
            --command-id "${{ steps.deploy.outputs.command-id }}" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --query "StandardOutputContent" \
            --output text

      # ============================================
      # 7. Summary
      # ============================================
      - name: ğŸ“Š Deployment Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ### âœ… Board Service Deployed

          - **Trigger:** \`${{ github.event_name }}\`
          - **Commit:** \`${{ github.sha }}\`
          - **Instance:** \`${{ secrets.EC2_INSTANCE_ID }}\`
          - **Command:** \`${{ steps.deploy.outputs.command-id }}\`
          EOF
