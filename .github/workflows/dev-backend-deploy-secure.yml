name: Backend EC2 CD - Secure (Parameter Store)

on:
  workflow_run:
    workflows:
      - "User Service CI - ECR"
      - "Board Service CI - ECR"
    types:
      - completed
    branches:
      - deploy-dev
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2

jobs:
  deploy-to-ec2:
    name: Secure Deploy via SSM
    runs-on: ubuntu-latest
    environment: development
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.WEALIST_DEV_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.WEALIST_DEV_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ“‹ Prepare Docker Compose File
        run: |
          cp docker/compose/docker-compose.ec2-dev.yml /tmp/docker-compose.yml

      - name: ðŸ“ Create Secure Deployment Script
        run: |
          cat > /tmp/deploy-secure.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e

          echo "=========================================="
          echo "ðŸ”’ Secure Deployment Started"
          echo "=========================================="

          REGION="ap-northeast-2"
          AWS_ACCOUNT_ID="${{ secrets.WEALIST_DEV_AWS_ACCOUNT_ID }}"

          # ë°°í¬ ë””ë ‰í† ë¦¬
          mkdir -p ~/wealist-deploy
          cd ~/wealist-deploy

          echo "ðŸ”‘ Fetching all configuration from Parameter Store..."

          # Parameter Storeì—ì„œ ëª¨ë“  ê°’ ê°€ì ¸ì˜¤ê¸° (Passwords & Secrets)
          POSTGRES_SUPERUSER_PASSWORD=$(aws ssm get-parameter \
            --name "/wealist/dev/postgres/superuser-password" \
            --with-decryption \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          USER_DB_PASSWORD=$(aws ssm get-parameter \
            --name "/wealist/dev/db/user-password" \
            --with-decryption \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          BOARD_DB_PASSWORD=$(aws ssm get-parameter \
            --name "/wealist/dev/db/board-password" \
            --with-decryption \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          REDIS_PASSWORD=$(aws ssm get-parameter \
            --name "/wealist/dev/redis/password" \
            --with-decryption \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          JWT_SECRET=$(aws ssm get-parameter \
            --name "/wealist/dev/jwt/secret" \
            --with-decryption \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          GOOGLE_CLIENT_ID=$(aws ssm get-parameter \
            --name "/wealist/dev/oauth/google-client-id" \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          GOOGLE_CLIENT_SECRET=$(aws ssm get-parameter \
            --name "/wealist/dev/oauth/google-client-secret" \
            --with-decryption \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          GRAFANA_ADMIN_PASSWORD=$(aws ssm get-parameter \
            --name "/wealist/dev/grafana/admin-password" \
            --with-decryption \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          # Parameter Storeì—ì„œ ëª¨ë“  ê°’ ê°€ì ¸ì˜¤ê¸° (Usernames & DB Names)
          POSTGRES_SUPERUSER=$(aws ssm get-parameter \
            --name "/wealist/dev/postgres/superuser" \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          USER_DB_NAME=$(aws ssm get-parameter \
            --name "/wealist/dev/db/user-name" \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          USER_DB_USER=$(aws ssm get-parameter \
            --name "/wealist/dev/db/user-username" \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          BOARD_DB_NAME=$(aws ssm get-parameter \
            --name "/wealist/dev/db/board-name" \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          BOARD_DB_USER=$(aws ssm get-parameter \
            --name "/wealist/dev/db/board-username" \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          GRAFANA_ADMIN_USER=$(aws ssm get-parameter \
            --name "/wealist/dev/grafana/admin-user" \
            --region ${REGION} \
            --query 'Parameter.Value' \
            --output text)

          echo "âœ… All configuration fetched from Parameter Store (14 parameters)"

          # .env íŒŒì¼ ìƒì„± (ëª¨ë“  ì„¤ì •ê°’ì„ Parameter Storeì—ì„œ ê°€ì ¸ì˜´)
          cat > .env << ENVFILE
          # AWS (ë¯¼ê°í•˜ì§€ ì•Šì€ ì •ë³´)
          AWS_REGION=${REGION}
          AWS_ACCOUNT_ID=${AWS_ACCOUNT_ID}
          VERSION=latest

          # PostgreSQL Superuser (Parameter Store)
          POSTGRES_SUPERUSER=${POSTGRES_SUPERUSER}
          POSTGRES_SUPERUSER_PASSWORD=${POSTGRES_SUPERUSER_PASSWORD}

          # User Service DB (Parameter Store)
          USER_DB_NAME=${USER_DB_NAME}
          USER_DB_USER=${USER_DB_USER}
          USER_DB_PASSWORD=${USER_DB_PASSWORD}

          # Board Service DB (Parameter Store)
          BOARD_DB_NAME=${BOARD_DB_NAME}
          BOARD_DB_USER=${BOARD_DB_USER}
          BOARD_DB_PASSWORD=${BOARD_DB_PASSWORD}

          # Redis (Parameter Store)
          REDIS_PASSWORD=${REDIS_PASSWORD}

          # JWT (Parameter Store)
          JWT_SECRET=${JWT_SECRET}
          JWT_ACCESS_TOKEN_EXPIRATION_MS=1800000
          JWT_REFRESH_TOKEN_EXPIRATION_MS=604800000

          # OAuth (Parameter Store)
          GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
          GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}

          # Service Configuration (ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •)
          JPA_DDL_AUTO=update
          JPA_SHOW_SQL=true
          JPA_FORMAT_SQL=true
          LOG_LEVEL=debug
          CORS_ORIGINS=*

          # Monitoring (Parameter Store)
          GRAFANA_ADMIN_USER=${GRAFANA_ADMIN_USER}
          GRAFANA_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
          ENVFILE

          # ë³´ì•ˆ: .env íŒŒì¼ ê¶Œí•œ ì œí•œ
          chmod 600 .env

          echo "âœ… Environment file created securely"

          # ECR ë¡œê·¸ì¸
          echo "ðŸ”‘ Logging into Amazon ECR..."
          aws ecr get-login-password --region ${REGION} | \
            docker login --username AWS --password-stdin \
            ${AWS_ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com

          # ìµœì‹  ì´ë¯¸ì§€ Pull
          echo "ðŸ“¥ Pulling latest images from ECR..."
          docker compose pull

          # ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
          echo "ðŸ”„ Restarting services..."
          docker compose up -d --remove-orphans

          # êµ¬ ì´ë¯¸ì§€ ì •ë¦¬
          echo "ðŸ§¹ Cleaning up old images..."
          docker image prune -f

          echo ""
          echo "=========================================="
          echo "âœ… Secure Deployment Complete!"
          echo "=========================================="
          docker compose ps

          # Health Check
          echo ""
          echo "ðŸ¥ Running Health Checks..."
          sleep 30

          USER_HEALTH=$(curl -f http://localhost:8080/actuator/health 2>/dev/null && echo "âœ… Healthy" || echo "âš ï¸ Not Ready")
          BOARD_HEALTH=$(curl -f http://localhost:8000/health 2>/dev/null && echo "âœ… Healthy" || echo "âš ï¸ Not Ready")

          echo "User Service: ${USER_HEALTH}"
          echo "Board Service: ${BOARD_HEALTH}"
          DEPLOY_SCRIPT

          chmod +x /tmp/deploy-secure.sh

      - name: ðŸ“¤ Upload to S3
        run: |
          BUCKET_NAME="wealist-deploy-scripts"
          aws s3 mb s3://${BUCKET_NAME} --region ${{ env.AWS_REGION }} 2>/dev/null || true
          aws s3 cp /tmp/docker-compose.yml s3://${BUCKET_NAME}/docker-compose.yml
          aws s3 cp /tmp/deploy-secure.sh s3://${BUCKET_NAME}/deploy-secure.sh

      - name: ðŸš€ Deploy via SSM
        run: |
          INSTANCE_ID="${{ secrets.EC2_INSTANCE_ID }}"
          BUCKET_NAME="wealist-deploy-scripts"

          echo "ðŸš€ Executing secure deployment on ${INSTANCE_ID}"

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${INSTANCE_ID}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "set -e",
              "cd /home/ec2-user/wealist-deploy || mkdir -p /home/ec2-user/wealist-deploy",
              "cd /home/ec2-user/wealist-deploy",
              "aws s3 cp s3://'"${BUCKET_NAME}"'/docker-compose.yml ./docker-compose.yml",
              "aws s3 cp s3://'"${BUCKET_NAME}"'/deploy-secure.sh ./deploy-secure.sh",
              "chmod +x ./deploy-secure.sh",
              "sudo -u ec2-user bash ./deploy-secure.sh"
            ]' \
            --region ${{ env.AWS_REGION }} \
            --output text \
            --query 'Command.CommandId')

          echo "Command ID: ${COMMAND_ID}"

          # ëª…ë ¹ ì™„ë£Œ ëŒ€ê¸°
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "${COMMAND_ID}" \
              --instance-id "${INSTANCE_ID}" \
              --region ${{ env.AWS_REGION }} \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")

            echo "[$(date +%H:%M:%S)] Status: ${STATUS}"

            if [ "${STATUS}" == "Success" ]; then
              echo "âœ… Deployment completed!"
              aws ssm get-command-invocation \
                --command-id "${COMMAND_ID}" \
                --instance-id "${INSTANCE_ID}" \
                --region ${{ env.AWS_REGION }} \
                --query 'StandardOutputContent' \
                --output text
              exit 0
            elif [ "${STATUS}" == "Failed" ]; then
              echo "âŒ Deployment failed!"
              aws ssm get-command-invocation \
                --command-id "${COMMAND_ID}" \
                --instance-id "${INSTANCE_ID}" \
                --region ${{ env.AWS_REGION }} \
                --query 'StandardErrorContent' \
                --output text
              exit 1
            fi

            sleep 10
          done

          echo "âš ï¸ Timeout"
          exit 1

      - name: ðŸ“‹ Deployment Summary
        if: always()
        run: |
          echo "### ðŸ”’ Secure Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Security Method:** AWS Parameter Store âœ…" >> $GITHUB_STEP_SUMMARY
          echo "**Instance ID:** \`${{ secrets.EC2_INSTANCE_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**âœ… Secrets not stored in GitHub**" >> $GITHUB_STEP_SUMMARY
          echo "**âœ… EC2 fetches secrets from Parameter Store**" >> $GITHUB_STEP_SUMMARY
          echo "**âœ… .env file secured with 600 permissions**" >> $GITHUB_STEP_SUMMARY
