name: Backend EC2 CD - SSM (Secure)

on:
  # User/Board Service CI ì›Œí¬í”Œë¡œìš° ì„±ê³µ ì‹œ íŠ¸ë¦¬ê±°
  workflow_run:
    workflows:
      - "User Service CI - ECR"
      - "Board Service CI - ECR"
    types:
      - completed
    branches:
      - deploy-dev

  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2

jobs:
  deploy-to-ec2:
    name: Deploy to EC2 via SSM
    runs-on: ubuntu-latest
    environment: development

    # CI ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      # ============================================
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # ============================================
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # ============================================
      # 2. AWS Credentials ì„¤ì •
      # ============================================
      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.WEALIST_DEV_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.WEALIST_DEV_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ============================================
      # 3. docker-compose.yml ì¤€ë¹„
      # ============================================
      - name: ðŸ“‹ Prepare Docker Compose File
        run: |
          cat docker/compose/docker-compose.ec2-dev.yml > /tmp/docker-compose.yml
          echo "Docker Compose file prepared"

      # ============================================
      # 4. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
      # ============================================
      - name: ðŸ“ Create Deployment Script
        run: |
          cat > /tmp/deploy.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e

          echo "=========================================="
          echo "ðŸš€ Starting Deployment"
          echo "=========================================="

          # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ~/wealist-deploy
          cd ~/wealist-deploy

          # .env íŒŒì¼ ìƒì„±
          cat > .env << 'ENVFILE'
          # AWS
          AWS_REGION=ap-northeast-2
          AWS_ACCOUNT_ID=${{ secrets.WEALIST_DEV_AWS_ACCOUNT_ID }}
          VERSION=latest

          # PostgreSQL Superuser
          POSTGRES_SUPERUSER=${{ secrets.POSTGRES_SUPERUSER }}
          POSTGRES_SUPERUSER_PASSWORD=${{ secrets.POSTGRES_SUPERUSER_PASSWORD }}

          # User Service DB
          USER_DB_NAME=${{ secrets.USER_DB_NAME }}
          USER_DB_USER=${{ secrets.USER_DB_USER }}
          USER_DB_PASSWORD=${{ secrets.USER_DB_PASSWORD }}

          # Board Service DB
          BOARD_DB_NAME=${{ secrets.BOARD_DB_NAME }}
          BOARD_DB_USER=${{ secrets.BOARD_DB_USER }}
          BOARD_DB_PASSWORD=${{ secrets.BOARD_DB_PASSWORD }}

          # Redis
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}

          # JWT
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_ACCESS_TOKEN_EXPIRATION_MS=1800000
          JWT_REFRESH_TOKEN_EXPIRATION_MS=604800000

          # OAuth
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}

          # Service Configuration
          JPA_DDL_AUTO=update
          JPA_SHOW_SQL=true
          JPA_FORMAT_SQL=true
          LOG_LEVEL=debug
          CORS_ORIGINS=*

          # Monitoring
          GRAFANA_ADMIN_USER=admin
          GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}
          ENVFILE

          echo "âœ… Environment file created"

          # ECR ë¡œê·¸ì¸
          echo "ðŸ”‘ Logging into Amazon ECR..."
          aws ecr get-login-password --region ap-northeast-2 | \
            docker login --username AWS --password-stdin \
            ${{ secrets.WEALIST_DEV_AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com

          # ìµœì‹  ì´ë¯¸ì§€ Pull
          echo "ðŸ“¥ Pulling latest images from ECR..."
          docker compose pull

          # ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
          echo "ðŸ”„ Restarting services..."
          docker compose up -d --remove-orphans

          # êµ¬ ì´ë¯¸ì§€ ì •ë¦¬
          echo "ðŸ§¹ Cleaning up old images..."
          docker image prune -f

          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo ""
          echo "=========================================="
          echo "âœ… Deployment Complete!"
          echo "=========================================="
          docker compose ps

          # Health Check
          echo ""
          echo "ðŸ¥ Running Health Checks..."
          sleep 30

          curl -f http://localhost:8080/actuator/health || echo "âš ï¸ User Service not ready yet"
          curl -f http://localhost:8000/health || echo "âš ï¸ Board Service not ready yet"
          DEPLOY_SCRIPT

          chmod +x /tmp/deploy.sh
          echo "Deployment script created"

      # ============================================
      # 5. S3ì— íŒŒì¼ ì—…ë¡œë“œ
      # ============================================
      - name: ðŸ“¤ Upload Files to S3
        run: |
          BUCKET_NAME="wealist-deploy-scripts"

          # S3 ë²„í‚·ì´ ì—†ìœ¼ë©´ ìƒì„± (ì—ëŸ¬ ë¬´ì‹œ)
          aws s3 mb s3://${BUCKET_NAME} --region ${{ env.AWS_REGION }} 2>/dev/null || true

          # íŒŒì¼ ì—…ë¡œë“œ
          aws s3 cp /tmp/docker-compose.yml s3://${BUCKET_NAME}/docker-compose.yml
          aws s3 cp /tmp/deploy.sh s3://${BUCKET_NAME}/deploy.sh

          echo "Files uploaded to S3"

      # ============================================
      # 6. SSMìœ¼ë¡œ EC2ì— ëª…ë ¹ ì‹¤í–‰
      # ============================================
      - name: ðŸš€ Deploy via SSM
        run: |
          INSTANCE_ID="${{ secrets.EC2_INSTANCE_ID }}"
          BUCKET_NAME="wealist-deploy-scripts"

          echo "Executing deployment on EC2 instance: ${INSTANCE_ID}"

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${INSTANCE_ID}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "set -e",
              "cd /home/ec2-user/wealist-deploy || mkdir -p /home/ec2-user/wealist-deploy",
              "cd /home/ec2-user/wealist-deploy",
              "aws s3 cp s3://'"${BUCKET_NAME}"'/docker-compose.yml ./docker-compose.yml",
              "aws s3 cp s3://'"${BUCKET_NAME}"'/deploy.sh ./deploy.sh",
              "chmod +x ./deploy.sh",
              "sudo -u ec2-user bash ./deploy.sh"
            ]' \
            --region ${{ env.AWS_REGION }} \
            --output text \
            --query 'Command.CommandId')

          echo "Command ID: ${COMMAND_ID}"
          echo "Waiting for command to complete..."

          # ëª…ë ¹ ì‹¤í–‰ ì™„ë£Œ ëŒ€ê¸° (ìµœëŒ€ 10ë¶„)
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "${COMMAND_ID}" \
              --instance-id "${INSTANCE_ID}" \
              --region ${{ env.AWS_REGION }} \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")

            echo "Status: ${STATUS}"

            if [ "${STATUS}" == "Success" ]; then
              echo "âœ… Deployment completed successfully!"

              # ì¶œë ¥ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°
              aws ssm get-command-invocation \
                --command-id "${COMMAND_ID}" \
                --instance-id "${INSTANCE_ID}" \
                --region ${{ env.AWS_REGION }} \
                --query 'StandardOutputContent' \
                --output text

              exit 0
            elif [ "${STATUS}" == "Failed" ]; then
              echo "âŒ Deployment failed!"

              # ì—ëŸ¬ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°
              aws ssm get-command-invocation \
                --command-id "${COMMAND_ID}" \
                --instance-id "${INSTANCE_ID}" \
                --region ${{ env.AWS_REGION }} \
                --query 'StandardErrorContent' \
                --output text

              exit 1
            fi

            sleep 10
          done

          echo "âš ï¸ Deployment timeout after 10 minutes"
          exit 1

      # ============================================
      # 7. ë°°í¬ ê²°ê³¼ ìš”ì•½
      # ============================================
      - name: ðŸ“‹ Deployment Summary
        if: always()
        run: |
          echo "### ðŸš€ EC2 Deployment Complete (SSM)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Development (EC2)" >> $GITHUB_STEP_SUMMARY
          echo "**Instance ID:** \`${{ secrets.EC2_INSTANCE_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** \`${{ github.event.workflow_run.name || 'Manual' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Method:** AWS Systems Manager (SSM) âœ… Secure" >> $GITHUB_STEP_SUMMARY
