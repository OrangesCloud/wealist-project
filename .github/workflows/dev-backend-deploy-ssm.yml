name: Backend EC2 CD - SSM (Secure)

on:
  # User/Board Service CI ì›Œí¬í”Œë¡œìš° ì„±ê³µ ì‹œ íŠ¸ë¦¬ê±°
  workflow_run:
    workflows:
      - "User Service CI - ECR"
      - "Board Service CI - ECR"
    types:
      - completed
    branches:
      - deploy-dev

  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2

jobs:
  deploy-to-ec2:
    name: Deploy to EC2 via SSM
    runs-on: ubuntu-latest
    environment: development

    # CI ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      # ============================================
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # ============================================
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # ============================================
      # 2. AWS Credentials ì„¤ì •
      # ============================================
      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.WEALIST_DEV_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.WEALIST_DEV_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ============================================
      # 3. docker-compose.yml ì¤€ë¹„
      # ============================================
      - name: ðŸ“‹ Prepare Docker Compose File
        run: |
          cat docker/compose/docker-compose.ec2-dev.yml > /tmp/docker-compose.yml
          echo "Docker Compose file prepared"

      # ============================================
      # 4. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (Parameter Store í†µí•©)
      # ============================================
      - name: ðŸ“ Create Deployment Script
        env:
          AWS_ACCOUNT_ID: ${{ secrets.WEALIST_DEV_AWS_ACCOUNT_ID }}
        run: |
          cat > /tmp/deploy.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e

          AWS_REGION="ap-northeast-2"

          echo "=========================================="
          echo "ðŸš€ Starting Deployment"
          echo "=========================================="

          # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ~/wealist-deploy
          cd ~/wealist-deploy

          # ============================================
          # Parameter Storeì—ì„œ í™˜ê²½ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸°
          # ============================================
          echo "ðŸ“¥ Fetching secrets from Parameter Store..."

          # Helper function to get parameter
          get_parameter() {
            aws ssm get-parameter \
              --name "$1" \
              --with-decryption \
              --region ${AWS_REGION} \
              --query 'Parameter.Value' \
              --output text 2>/dev/null || echo ""
          }

          # Fetch all parameters
          POSTGRES_SUPERUSER=$(get_parameter "/wealist/dev/postgres-superuser")
          POSTGRES_SUPERUSER_PASSWORD=$(get_parameter "/wealist/dev/postgres-superuser-password")
          USER_DB_NAME=$(get_parameter "/wealist/dev/user-db-name")
          USER_DB_USER=$(get_parameter "/wealist/dev/user-db-user")
          USER_DB_PASSWORD=$(get_parameter "/wealist/dev/user-db-password")
          BOARD_DB_NAME=$(get_parameter "/wealist/dev/board-db-name")
          BOARD_DB_USER=$(get_parameter "/wealist/dev/board-db-user")
          BOARD_DB_PASSWORD=$(get_parameter "/wealist/dev/board-db-password")
          REDIS_PASSWORD=$(get_parameter "/wealist/dev/redis-password")
          JWT_SECRET=$(get_parameter "/wealist/dev/jwt-secret")
          GOOGLE_CLIENT_ID=$(get_parameter "/wealist/dev/google-client-id")
          GOOGLE_CLIENT_SECRET=$(get_parameter "/wealist/dev/google-client-secret")
          GRAFANA_ADMIN_USER=$(get_parameter "/wealist/dev/grafana-admin-user")
          GRAFANA_ADMIN_PASSWORD=$(get_parameter "/wealist/dev/grafana-admin-password")

          # Validation: Check critical parameters
          if [[ -z "$POSTGRES_SUPERUSER_PASSWORD" ]] || [[ -z "$JWT_SECRET" ]]; then
            echo "âŒ Error: Failed to fetch critical parameters from Parameter Store"
            echo "Please verify:"
            echo "  1. EC2 Instance Profile is attached"
            echo "  2. Parameters exist in Parameter Store"
            echo "  3. IAM permissions are correct"
            exit 1
          fi

          echo "âœ… Successfully fetched all parameters"

          # ============================================
          # .env íŒŒì¼ ìƒì„± (ë™ì ìœ¼ë¡œ)
          # ============================================
          cat > .env << 'ENVFILE'
AWS_REGION=\${AWS_REGION}
AWS_ACCOUNT_ID=\${AWS_ACCOUNT_ID}
VERSION=latest
POSTGRES_SUPERUSER=\${POSTGRES_SUPERUSER}
POSTGRES_SUPERUSER_PASSWORD=\${POSTGRES_SUPERUSER_PASSWORD}
USER_DB_NAME=\${USER_DB_NAME}
USER_DB_USER=\${USER_DB_USER}
USER_DB_PASSWORD=\${USER_DB_PASSWORD}
BOARD_DB_NAME=\${BOARD_DB_NAME}
BOARD_DB_USER=\${BOARD_DB_USER}
BOARD_DB_PASSWORD=\${BOARD_DB_PASSWORD}
REDIS_PASSWORD=\${REDIS_PASSWORD}
JWT_SECRET=\${JWT_SECRET}
JWT_ACCESS_TOKEN_EXPIRATION_MS=1800000
JWT_REFRESH_TOKEN_EXPIRATION_MS=604800000
GOOGLE_CLIENT_ID=\${GOOGLE_CLIENT_ID}
GOOGLE_CLIENT_SECRET=\${GOOGLE_CLIENT_SECRET}
JPA_DDL_AUTO=update
JPA_SHOW_SQL=true
JPA_FORMAT_SQL=true
LOG_LEVEL=debug
CORS_ORIGINS=*
GRAFANA_ADMIN_USER=\${GRAFANA_ADMIN_USER}
GRAFANA_ADMIN_PASSWORD=\${GRAFANA_ADMIN_PASSWORD}
ENVFILE

          # í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜
          sed -i "s/\\\${AWS_REGION}/${AWS_REGION}/g" .env
          sed -i "s/\\\${AWS_ACCOUNT_ID}/${AWS_ACCOUNT_ID}/g" .env
          sed -i "s/\\\${POSTGRES_SUPERUSER}/${POSTGRES_SUPERUSER}/g" .env
          sed -i "s/\\\${POSTGRES_SUPERUSER_PASSWORD}/${POSTGRES_SUPERUSER_PASSWORD}/g" .env
          sed -i "s/\\\${USER_DB_NAME}/${USER_DB_NAME}/g" .env
          sed -i "s/\\\${USER_DB_USER}/${USER_DB_USER}/g" .env
          sed -i "s/\\\${USER_DB_PASSWORD}/${USER_DB_PASSWORD}/g" .env
          sed -i "s/\\\${BOARD_DB_NAME}/${BOARD_DB_NAME}/g" .env
          sed -i "s/\\\${BOARD_DB_USER}/${BOARD_DB_USER}/g" .env
          sed -i "s/\\\${BOARD_DB_PASSWORD}/${BOARD_DB_PASSWORD}/g" .env
          sed -i "s/\\\${REDIS_PASSWORD}/${REDIS_PASSWORD}/g" .env
          sed -i "s/\\\${JWT_SECRET}/${JWT_SECRET}/g" .env
          sed -i "s/\\\${GOOGLE_CLIENT_ID}/${GOOGLE_CLIENT_ID}/g" .env
          sed -i "s/\\\${GOOGLE_CLIENT_SECRET}/${GOOGLE_CLIENT_SECRET}/g" .env
          sed -i "s/\\\${GRAFANA_ADMIN_USER}/${GRAFANA_ADMIN_USER}/g" .env
          sed -i "s/\\\${GRAFANA_ADMIN_PASSWORD}/${GRAFANA_ADMIN_PASSWORD}/g" .env

          echo "âœ… Environment file created"

          # ECR ë¡œê·¸ì¸
          echo "ðŸ”‘ Logging into Amazon ECR..."
          aws ecr get-login-password --region ${AWS_REGION} | \
            docker login --username AWS --password-stdin \
            ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

          # ìµœì‹  ì´ë¯¸ì§€ Pull
          echo "ðŸ“¥ Pulling latest images from ECR..."
          docker compose pull

          # ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
          echo "ðŸ”„ Restarting services..."
          docker compose up -d --remove-orphans

          # êµ¬ ì´ë¯¸ì§€ ì •ë¦¬
          echo "ðŸ§¹ Cleaning up old images..."
          docker image prune -f

          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo ""
          echo "=========================================="
          echo "âœ… Deployment Complete!"
          echo "=========================================="
          docker compose ps

          # Health Check
          echo ""
          echo "ðŸ¥ Running Health Checks..."
          sleep 30

          curl -f http://localhost:8080/actuator/health || echo "âš ï¸ User Service not ready yet"
          curl -f http://localhost:8000/health || echo "âš ï¸ Board Service not ready yet"
          DEPLOY_SCRIPT

          # AWS_ACCOUNT_IDë¥¼ ìŠ¤í¬ë¦½íŠ¸ì— ì£¼ìž…
          sed -i "s/\${AWS_ACCOUNT_ID}/$AWS_ACCOUNT_ID/g" /tmp/deploy.sh

          chmod +x /tmp/deploy.sh
          echo "âœ… Deployment script created with Parameter Store integration"

      # ============================================
      # 5. S3ì— íŒŒì¼ ì—…ë¡œë“œ
      # ============================================
      - name: ðŸ“¤ Upload Files to S3
        run: |
          BUCKET_NAME="wealist-deploy-scripts"

          # S3 ë²„í‚·ì´ ì—†ìœ¼ë©´ ìƒì„± (ì—ëŸ¬ ë¬´ì‹œ)
          aws s3 mb s3://${BUCKET_NAME} --region ${{ env.AWS_REGION }} 2>/dev/null || true

          # íŒŒì¼ ì—…ë¡œë“œ
          aws s3 cp /tmp/docker-compose.yml s3://${BUCKET_NAME}/docker-compose.yml
          aws s3 cp /tmp/deploy.sh s3://${BUCKET_NAME}/deploy.sh

          echo "Files uploaded to S3"

      # ============================================
      # 6. SSMìœ¼ë¡œ EC2ì— ëª…ë ¹ ì‹¤í–‰
      # ============================================
      - name: ðŸš€ Deploy via SSM
        run: |
          INSTANCE_ID="${{ secrets.EC2_INSTANCE_ID }}"
          BUCKET_NAME="wealist-deploy-scripts"

          echo "Executing deployment on EC2 instance: ${INSTANCE_ID}"

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${INSTANCE_ID}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "set -e",
              "cd /home/ec2-user/wealist-deploy || mkdir -p /home/ec2-user/wealist-deploy",
              "cd /home/ec2-user/wealist-deploy",
              "aws s3 cp s3://'"${BUCKET_NAME}"'/docker-compose.yml ./docker-compose.yml",
              "aws s3 cp s3://'"${BUCKET_NAME}"'/deploy.sh ./deploy.sh",
              "chmod +x ./deploy.sh",
              "sudo -u ec2-user bash ./deploy.sh"
            ]' \
            --region ${{ env.AWS_REGION }} \
            --output text \
            --query 'Command.CommandId')

          echo "Command ID: ${COMMAND_ID}"
          echo "Waiting for command to complete..."

          # ëª…ë ¹ ì‹¤í–‰ ì™„ë£Œ ëŒ€ê¸° (ìµœëŒ€ 10ë¶„)
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "${COMMAND_ID}" \
              --instance-id "${INSTANCE_ID}" \
              --region ${{ env.AWS_REGION }} \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")

            echo "Status: ${STATUS}"

            if [ "${STATUS}" == "Success" ]; then
              echo "âœ… Deployment completed successfully!"

              # ì¶œë ¥ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°
              aws ssm get-command-invocation \
                --command-id "${COMMAND_ID}" \
                --instance-id "${INSTANCE_ID}" \
                --region ${{ env.AWS_REGION }} \
                --query 'StandardOutputContent' \
                --output text

              exit 0
            elif [ "${STATUS}" == "Failed" ]; then
              echo "âŒ Deployment failed!"

              # ì—ëŸ¬ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°
              aws ssm get-command-invocation \
                --command-id "${COMMAND_ID}" \
                --instance-id "${INSTANCE_ID}" \
                --region ${{ env.AWS_REGION }} \
                --query 'StandardErrorContent' \
                --output text

              exit 1
            fi

            sleep 10
          done

          echo "âš ï¸ Deployment timeout after 10 minutes"
          exit 1

      # ============================================
      # 7. ë°°í¬ ê²°ê³¼ ìš”ì•½
      # ============================================
      - name: ðŸ“‹ Deployment Summary
        if: always()
        run: |
          echo "### ðŸš€ EC2 Deployment Complete (SSM)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Development (EC2)" >> $GITHUB_STEP_SUMMARY
          echo "**Instance ID:** \`${{ secrets.EC2_INSTANCE_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** \`${{ github.event.workflow_run.name || 'Manual' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Method:** AWS Systems Manager (SSM) âœ… Secure" >> $GITHUB_STEP_SUMMARY
