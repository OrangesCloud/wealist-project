name: Backend EC2 CD - ECR

on:
  # User/Board Service CI ì›Œí¬í”Œë¡œìš° ì„±ê³µ ì‹œ íŠ¸ë¦¬ê±°
  workflow_run:
    workflows:
      - "User Service CI - ECR"
      - "Board Service CI - ECR"
    types:
      - completed
    branches:
      - deploy-dev  # Dev í™˜ê²½ ë°°í¬ ì „ìš© ë¸Œëœì¹˜

  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2

jobs:
  deploy-to-ec2:
    name: Deploy to EC2 Dev Environment
    runs-on: ubuntu-latest
    environment: development

    # CI ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      # ============================================
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ (docker-compose íŒŒì¼ í•„ìš”)
      # ============================================
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # ============================================
      # 2. SSH ì ‘ì† í‚¤ ì„¤ì •
      # ============================================
      - name: ğŸ”‘ Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

      # ============================================
      # 3. EC2 Known Hosts ë“±ë¡
      # ============================================
      - name: ğŸ“ Add EC2 to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # ============================================
      # 4. Docker Compose íŒŒì¼ EC2ë¡œ ì „ì†¡
      # ============================================
      - name: ğŸ“¤ Copy Docker Compose Files to EC2
        run: |
          ssh ec2-user@${{ secrets.EC2_HOST }} "mkdir -p ~/wealist-deploy"

          scp docker/compose/docker-compose.ec2-dev.yml \
            ec2-user@${{ secrets.EC2_HOST }}:~/wealist-deploy/docker-compose.yml

          scp docker/scripts/ec2-dev.sh \
            ec2-user@${{ secrets.EC2_HOST }}:~/wealist-deploy/deploy.sh

      # ============================================
      # 5. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± (EC2ì—ì„œ)
      # ============================================
      - name: ğŸ”§ Create Environment File on EC2
        run: |
          ssh ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            cat > ~/wealist-deploy/.env << ENVFILE
          # Application
          APP_NAME=wealist-api
          VERSION=latest

          # AWS
          AWS_REGION=${{ env.AWS_REGION }}
          AWS_ACCOUNT_ID=${{ secrets.WEALIST_DEV_AWS_ACCOUNT_ID }}

          # Database - User Service
          USER_DB_NAME=${{ secrets.USER_DB_NAME }}
          USER_DB_USER=${{ secrets.USER_DB_USER }}
          USER_DB_PASSWORD=${{ secrets.USER_DB_PASSWORD }}

          # Database - Board Service
          BOARD_DB_NAME=${{ secrets.BOARD_DB_NAME }}
          BOARD_DB_USER=${{ secrets.BOARD_DB_USER }}
          BOARD_DB_PASSWORD=${{ secrets.BOARD_DB_PASSWORD }}

          # Database - Superuser
          POSTGRES_SUPERUSER=${{ secrets.POSTGRES_SUPERUSER }}
          POSTGRES_SUPERUSER_PASSWORD=${{ secrets.POSTGRES_SUPERUSER_PASSWORD }}

          # Redis
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}

          # JWT
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_ACCESS_TOKEN_EXPIRATION_MS=1800000
          JWT_REFRESH_TOKEN_EXPIRATION_MS=604800000

          # OAuth
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}

          # Service Configuration
          JPA_DDL_AUTO=update
          JPA_SHOW_SQL=true
          JPA_FORMAT_SQL=true
          LOG_LEVEL=debug

          # CORS
          CORS_ORIGINS=*

          # Monitoring
          GRAFANA_ADMIN_USER=admin
          GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}
          ENVFILE
          EOF

      # ============================================
      # 6. EC2ì— ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      # ============================================
      - name: ğŸš€ Deploy to EC2
        run: |
          ssh ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/wealist-deploy

            echo "=========================================="
            echo "ğŸ” Logging into Amazon ECR..."
            echo "=========================================="
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
              docker login --username AWS --password-stdin \
              ${{ secrets.WEALIST_DEV_AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com

            echo ""
            echo "=========================================="
            echo "ğŸ“¥ Pulling latest images from ECR..."
            echo "=========================================="
            docker compose --env-file .env pull

            echo ""
            echo "=========================================="
            echo "ğŸ”„ Restarting services..."
            echo "=========================================="
            docker compose --env-file .env up -d --remove-orphans

            echo ""
            echo "=========================================="
            echo "ğŸ§¹ Cleaning up old images..."
            echo "=========================================="
            docker image prune -f

            echo ""
            echo "=========================================="
            echo "âœ… Deployment Complete!"
            echo "=========================================="
            docker compose --env-file .env ps
          EOF

      # ============================================
      # 7. í—¬ìŠ¤ì²´í¬ (ë°°í¬ í›„ ì„œë¹„ìŠ¤ í™•ì¸)
      # ============================================
      - name: ğŸ¥ Health Check
        run: |
          ssh ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            echo ""
            echo "=========================================="
            echo "ğŸ¥ Running Health Checks..."
            echo "=========================================="

            sleep 30  # ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸°

            # User Service Health Check
            echo "Checking User Service..."
            curl -f http://localhost:8080/actuator/health || echo "âš ï¸ User Service health check failed"

            # Board Service Health Check
            echo "Checking Board Service..."
            curl -f http://localhost:8000/health || echo "âš ï¸ Board Service health check failed"

            echo ""
            echo "=========================================="
            echo "ğŸ“Š Service Status"
            echo "=========================================="
            docker compose --env-file ~/wealist-deploy/.env ps
          EOF

      # ============================================
      # 8. ë°°í¬ ê²°ê³¼ ìš”ì•½
      # ============================================
      - name: ğŸ“‹ Deployment Summary
        if: always()
        run: |
          echo "### ğŸš€ EC2 Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Development (EC2)" >> $GITHUB_STEP_SUMMARY
          echo "**Host:** \`${{ secrets.EC2_HOST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** \`${{ github.event.workflow_run.name || 'Manual' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services:**" >> $GITHUB_STEP_SUMMARY
          echo "- User Service: http://${{ secrets.EC2_HOST }}:8080" >> $GITHUB_STEP_SUMMARY
          echo "- Board Service: http://${{ secrets.EC2_HOST }}:8000" >> $GITHUB_STEP_SUMMARY
          echo "- Grafana: http://${{ secrets.EC2_HOST }}:3001" >> $GITHUB_STEP_SUMMARY
